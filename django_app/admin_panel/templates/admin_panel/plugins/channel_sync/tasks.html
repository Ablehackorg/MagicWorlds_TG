<!-- templates/admin_panel/plugins/channel_sync/tasks.html -->
{% extends "adminlte/base.html" %}
{% load static %}
{% load filters %}

{% block content %}
<section class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">{{ page_title }}</h1>
      
      <!-- Контейнер для иконок -->
      <div class="d-flex align-items-center" style="gap: 8px;">
        <!-- Шестерёнка -->
        <span class="col-toggle-btn d-inline-flex align-items-center" title="Управление столбцами" style="cursor:pointer;">
          <i class="fas fa-cog"></i>
        </span>
      </div>
    </div>

    <!-- Кнопка "Добавить" -->
    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'admin_panel:channel_sync_task_add' %}" class="btn btn-add">
        <i class="fas fa-plus"></i> Добавить
      </a>
    </div>

    <!-- Таблица -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="channelSyncTable" data-sortable data-paginate>
        <thead>
          <tr>
            <th>ID</th>
            <th class="col-status">Статус</th>
            <th>Канал-Источник</th>
            <th>Постов в источнике</th>
            <th>Канал-Библиотека</th>
            <th>Постов в цели</th>
            <th>Страна</th>
            <th>Последний update</th>
            <th>Статус update</th>
            <th>Период update</th>
            <th>Действия</th>
          </tr>
        </thead>

        <tbody>
          {% for task_data in tasks_with_progress %}
            {% with task_data.task as t %}
            {% with task_data.sync_progress_percent as sync_progress_percent %}
            {% with task_data.target_posts_count as target_posts_count %}
            <tr>
              <!-- ID -->
              <td class="text-center">{{ t.id }}</td>

              <!-- Статус -->
              <td class="col-status text-center">
                {% if t.is_active %}
                  <span class="status-dot active" title="Активна"></span>
                {% else %}
                  <span class="status-dot gray" title="Неактивна"></span>
                {% endif %}
              </td>

              <!-- Канал-Источник -->
              <td>{{ t.source.name|default:"—" }}</td>

              <!-- Постов источника -->
              <td class="text-center">
                {% if t.progress %}
                  {{ t.progress.total_posts_to_copy|default:"0" }}
                {% else %}
                  0
                {% endif %}
              </td>

              <!-- Канал-Библиотека -->
              <td>
                {% if t.target.link|slice:':7' == 'http://' or t.target.link|slice:':8' == 'https://' %}
                    <a href="{{ t.target.link }}" target="_blank">{{ t.target.name }}</a>
                {% else %}
                    <a href="https://{{ t.target.link }}" target="_blank">{{ t.target.name }}</a>
                {% endif %}
              </td>

              <!-- Постов цели -->
              <td class="text-center">
                {{ task_data.true_copied_posts|default:"0" }}
              </td>

              <!-- Страна -->
              <td class="text-center">{{ t.source.country.name|default:"—" }}</td>

              <!-- Последний update -->
              <td class="text-center">
                {% if t.last_sync_date %}
                  {{ t.last_sync_date|date:"d.m.Y H:i" }}
                {% else %}
                  —
                {% endif %}
              </td>

              <!-- Статус update -->
              <td class="text-center">
                <span class="{% if sync_progress_percent < 100 %}text-danger{% endif %}">
                  {{ sync_progress_percent|floatformat:0 }}%
                </span>
              </td>

              <!-- Период update -->
              <td class="text-center">{{ t.update_period_display|default:"—" }}</td>

              <!-- Действия -->
              <td class="text-center text-nowrap">
                <a href="{% url 'admin_panel:channel_sync_task_edit' t.id %}" title="Редактировать">
                  <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать" class="icon-16 mr-2">
                </a>
                <a href="{% url 'admin_panel:channel_sync_task_delete' t.id %}" title="Удалить">
                  <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16 mr-2">
                </a>
              </td>
            </tr>
            {% endwith %}
            {% endwith %}
            {% endwith %}
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted">Задачи отсутствуют</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

<!-- JS -->
<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";

  initSortableTables();
  initTablePagination(20);
</script>

{% endblock %}