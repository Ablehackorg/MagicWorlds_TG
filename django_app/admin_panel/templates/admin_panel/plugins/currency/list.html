{% extends "adminlte/base.html" %}
{% load static %}

{% block content %}
<section class="content">
    <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="mb-0">Валюта - курс</h1>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <div class="mr-auto">
                {# Кнопка настроек глобальных параметров, если нужно #}
                <button class="btn btn-secondary" onclick="toggleGlobals()">
                    <i class="fas fa-cog"></i> Глобальные настройки
                </button>
            </div>
            <a href="{% url 'admin_panel:currency_create' %}" class="btn btn-add">
                <i class="fas fa-plus"></i> Добавить локацию
            </a>
        </div>

        {# Глобальные настройки (скрытые по умолчанию) #}
        <div id="globalsSection" class="card card-outline card-primary mb-4" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">Глобальные настройки плагина</h3>
            </div>
            <div class="card-body">
                <form method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3">
                            <label>Время публикации:</label>
                            <input type="time" name="publication_time"
                                value="{{ globals_obj.publication_time|time:'H:i' }}" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label>Закреп (Основной):</label>
                            <select name="pin_main" class="form-control">
                                <option value="0" {% if globals_obj.pin_main_chat == 0 %}selected{% endif %}>Не закреплять
                                </option>
                                <option value="1" {% if globals_obj.pin_main_chat  ==  1 %}selected{% endif %}>1 сутки
                                </option>
                                <option value="2" {% if globals_obj.pin_main_chat  ==  2 %}selected{% endif %}>2 суток
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Закреп (Безопасный):</label>
                            <select name="pin_safe" class="form-control">
                                <option value="0" {% if globals_obj.pin_safe_exchange == 0 %}selected{% endif %}>Не
                                    закреплять</option>
                                <option value="1" {% if globals_obj.pin_safe_exchange == 1 %}selected{% endif %}>1 сутки
                                </option>
                                <option value="2" {% if globals_obj.pin_safe_exchange == 2 %}selected{% endif %}>2 суток
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Заставка (фото/видео):</label>
                            <input type="file" name="cover" class="form-control-file">
                            {% if globals_obj.cover %}
                            <small class="text-success">Файл загружен: <a href="{{ globals_obj.cover.url }}"
                                    target="_blank">открыть</a></small>
                            {% endif %}
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" name="save_globals" class="btn btn-primary w-100">Сохранить</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="currencyTable" data-sortable data-paginate>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Страна</th>
                        <th>Статус</th>
                        <th>Бот</th>
                        <th>Ошибок</th>
                        <th>Последняя публикация</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loc in locations %}
                    <tr>
                        <td>{{ loc.id }}</td>
                        <td>
                            {{ loc.emoji }} {{ loc.country.name|default:loc.name }}
                        </td>
                        <td class="text-center">
                            {% if loc.last_status  ==  'success' %}
                            <span class="status-dot active" title="Успешно"></span>
                            {% elif loc.last_status  ==  'error' %}
                            <span class="status-dot red" title="Ошибка"></span>
                            {% else %}
                            <span class="status-dot gray" title="Не запускался"></span>
                            {% endif %}
                        </td>
                        <td>{{ loc.bot.name|default:"—" }}</td>
                        <td class="text-center">
                            {% if loc.error_count > 0 %}
                            <span class="badge badge-danger">{{ loc.error_count }}</span>
                            {% else %}
                            0
                            {% endif %}
                        </td>
                        <td>
                            {% if loc.last_published %}
                            {{ loc.last_published|date:"d.m.Y H:i" }}
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'admin_panel:currency_edit' loc.id %}" title="Редактировать">
                                <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать"
                                    class="icon-16 mr-2">
                            </a>
                            <a href="#"
                                onclick="if(confirm('Удалить локацию?')) window.location.href='{% url 'admin_panel:currency_delete' loc.id %}'"
                                title="Удалить">
                                <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16">
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">Локации не настроены</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Пагинация проекта #}
        {% if page_obj.has_other_pages %}
        <div class="mt-3">
            {% include "admin_panel/includes/pagination.html" %}
        </div>
        {% endif %}

    </div>
</section>

<script>
    function toggleGlobals() {
        const section = document.getElementById('globalsSection');
        section.style.display = section.style.display = ==  'none' ? 'block' : 'none';
    }
</script>

<script type="module">
    import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
    import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
    initSortableTables();
    initTablePagination({{ page_size }});
</script>
{% endblock %}