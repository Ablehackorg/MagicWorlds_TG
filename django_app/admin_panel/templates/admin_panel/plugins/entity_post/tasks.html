{% extends "adminlte/base.html" %}
{% load static %}
{% load filters %}

{% block content %}
<section class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">Задачи публикаций в группы</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'admin_panel:entity_post_task_create' %}" class="btn btn-add">
        <i class="fas fa-plus"></i> Добавить
      </a>
    </div>

    {% if api_error %}
      <div class="alert alert-danger">{{ api_error }}</div>
    {% endif %}

    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="groupsTable" data-sortable data-paginate>
        <thead>
          <tr>
            <th>ID</th>
            <th>Бот</th>
            <th>Источник</th>
            <th class="col-status">Статус</th>
            <th>Целей</th>
            <th>Дни</th>
            <th>Время</th>
            <th>Выбор</th>
            <th>После публикации</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for g in task_groups %}
          <tr>
            <!-- ID группы -->
            <td>{{ g.id }}</td>

            <!-- Бот -->
            <td>{{ g.bot.name|default:"—" }}</td>

            <!-- Источник -->
            <td>{% if g.source %}{{ g.source.name }}{% else %}—{% endif %}</td>

            <!-- Состояние -->
            <td class="col-status">
              {% if g.is_global_active %}
                <span class="status-dot active" title="Активна"></span>
              {% else %}
                <span class="status-dot inactive" title="Неактивна"></span>
              {% endif %}
            </td>

            <!-- Кол-во целей -->
            <td>{{ g.targets_count }}</td>

            <!-- Дни недели -->
            <td>
              {% if g.days|length == 7 %}
                Все
              {% else %}
                {% for d in g.days %}
                  {{ weekdays|get_item:d }}
                  {% if not forloop.last %}, {% endif %}
                {% empty %}
                  —
                {% endfor %}
              {% endif %}
            </td>

            <!-- Время -->
            <td>
              {% if g.time %}
                {{ g.time|seconds_to_hours|stringformat:"02d" }}:{{ g.time|seconds_to_minutes|stringformat:"02d" }}
              {% else %}
                —
              {% endif %}
            </td>

            <!-- Режим -->
            <td>
              {% if g.choice_mode == "random" %}
                <span class="badge badge-info">Случайно</span>
              {% else %}
                <span class="badge badge-primary">Последовательно</span>
              {% endif %}
            </td>

            <!-- После публикации -->
            <td>
              {% if g.after_publish == "cycle" %}
                <span class="badge badge-success">По кругу</span>
              {% else %}
                <span class="badge badge-danger">Удалять</span>
              {% endif %}
            </td>

            <!-- Действия -->
            <td class="text-center">
              <!-- Редактировать -->
              <a href="{% url 'admin_panel:entity_post_task_edit' g.id %}" title="Редактировать">
                <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать" class="icon-16 mr-2">
              </a>

              <!-- Удалить -->
              <form method="post" action="{% url 'admin_panel:entity_post_task_delete' g.id %}"
                    style="display:inline;" onsubmit="return confirm('Удалить группу #{{ g.id }} и все её подзадачи?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-link p-0 m-0" title="Удалить">
                  <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16">
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="10" class="text-center text-muted">Группы задач отсутствуют</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";

  initSortableTables();
  initTablePagination(20);
</script>
{% endblock %}
