{% extends "adminlte/base.html" %}
{% load static %}

{% block content %}
<section class="content">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">Плагины</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <ul class="nav nav-tabs" id="pluginTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="working-tab" data-toggle="tab" href="#working" role="tab">В работе</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="system-tab" data-toggle="tab" href="#system" role="tab">Системные</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="theme-tab" data-toggle="tab" href="#theme" role="tab">Тематические</a>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- В работе -->
      <div class="tab-pane fade show active" id="working" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-bordered table-hover" 
             id="groupsTable" data-sortable data-paginate>

            <thead>
              <tr>
                <th>Название</th>
                <th>Контейнер</th>
                <th>Статус Docker</th>
                <th>Описание</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for p in working_plugins %}
                <tr>
                  <td>{{ p.name }}</td>
                  <td>{{ p.container_name|default:"—" }}</td>
                  <td>{{ p.docker_status }}</td>
                  <td>{{ p.description }}</td>
                  <td class="text-nowrap">
                    <!-- Иконка "Задачи" для модулей с задачами -->
                    {% if p.container_name in "ads_post,blondinka,channel_sync,group_post,old_views_booster,reaction_booster,subscribers_booster,view_booster,daily_pinning" %}
                      {% if p.container_name == "group_post" %}
                        <a href="{% url 'admin_panel:entity_post_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "ads_post" %}
                        <a href="{% url 'admin_panel:ads_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "blondinka" %}
                        <a href="{% url 'admin_panel:blondinka_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "channel_sync" %}
                        <a href="{% url 'admin_panel:channel_sync_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "old_views_booster" %}
                        <a href="{% url 'admin_panel:old_views_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "reaction_booster" %}
                        <a href="{% url 'admin_panel:reaction_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "subscribers_booster" %}
                        <a href="{% url 'admin_panel:subscribers_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "view_booster" %}
                        <a href="{% url 'admin_panel:view_boost_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "daily_pinning" %}
                        <a href="{% url 'admin_panel:daily_pinning_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% endif %}
                    {% endif %}

                    <!-- Управление состоянием контейнера -->
                    {% if p.docker_status == "running" %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'stop' %}" title="Остановить">
                        <img src="{% static 'admin_panel/img/stop.png' %}" alt="Остановить" class="icon-16">
                      </a>&nbsp;
                      <a href="{% url 'admin_panel:plugin_action' p.id 'restart' %}" title="Перезагрузить">
                        <img src="{% static 'admin_panel/img/reload.png' %}" alt="Перезагрузить" class="icon-16">
                      </a>
                    {% else %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'start' %}" title="Запустить">
                        <img src="{% static 'admin_panel/img/start.png' %}" alt="Запустить" class="icon-16">
                      </a>
                    {% endif %}
                    
                    <!-- Логи -->
                    &nbsp;<a href="{% url 'admin_panel:plugin_logs' p.id %}" title="Логи">
                      <img src="{% static 'admin_panel/img/logs.png' %}" alt="Логи" class="icon-16">
                    </a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-muted text-center">Нет плагинов</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Системные -->
      <div class="tab-pane fade" id="system" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-bordered table-hover" data-sortable>
            <thead>
              <tr>
                <th>Название</th>
                <th>Контейнер</th>
                <th>Статус Docker</th>
                <th>Описание</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for p in system_plugins %}
                <tr>
                  <td>{{ p.name }}</td>
                  <td>{{ p.container_name|default:"—" }}</td>
                  <td>{{ p.docker_status }}</td>
                  <td>{{ p.description }}</td>
                  <td class="text-nowrap">
                    <!-- Иконка "Задачи" для модулей с задачами -->
                    {% if p.container_name in "ads_post,blondinka,channel_sync,group_post,old_views_booster,reaction_booster,subscribers_booster,view_booster,daily_pinning" %}
                      {% if p.container_name == "group_post" %}
                        <a href="{% url 'admin_panel:entity_post_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "ads_post" %}
                        <a href="{% url 'admin_panel:ads_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "blondinka" %}
                        <a href="{% url 'admin_panel:blondinka_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "channel_sync" %}
                        <a href="{% url 'admin_panel:channel_sync_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "old_views_booster" %}
                        <a href="{% url 'admin_panel:old_views_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "reaction_booster" %}
                        <a href="{% url 'admin_panel:reaction_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "subscribers_booster" %}
                        <a href="{% url 'admin_panel:subscribers_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "view_booster" %}
                        <a href="{% url 'admin_panel:view_boost_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "pinner" %}
                        <a href="{% url 'admin_panel:daily_pinning_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% endif %}
                    {% endif %}

                    <!-- Управление состоянием контейнера -->
                    {% if p.docker_status == "running" %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'stop' %}" title="Остановить">
                        <img src="{% static 'admin_panel/img/stop.png' %}" alt="Остановить" class="icon-16">
                      </a>&nbsp;
                      <a href="{% url 'admin_panel:plugin_action' p.id 'restart' %}" title="Перезагрузить">
                        <img src="{% static 'admin_panel/img/reload.png' %}" alt="Перезагрузить" class="icon-16">
                      </a>
                    {% else %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'start' %}" title="Запустить">
                        <img src="{% static 'admin_panel/img/start.png' %}" alt="Запустить" class="icon-16">
                      </a>
                    {% endif %}
                    
                    <!-- Логи -->
                    &nbsp;<a href="{% url 'admin_panel:plugin_logs' p.id %}" title="Логи">
                      <img src="{% static 'admin_panel/img/logs.png' %}" alt="Логи" class="icon-16">
                    </a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-muted text-center">Нет плагинов</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Тематические -->
      <div class="tab-pane fade" id="theme" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-bordered table-hover" data-sortable>
            <thead>
              <tr>
                <th>Название</th>
                <th>Контейнер</th>
                <th>Статус Docker</th>
                <th>Описание</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for p in theme_plugins %}
                <tr>
                  <td>{{ p.name }}</td>
                  <td>{{ p.container_name|default:"—" }}</td>
                  <td>{{ p.docker_status }}</td>
                  <td>{{ p.description }}</td>
                  <td class="text-nowrap">
                    <!-- Иконка "Задачи" для модулей с задачами -->
                    {% if p.container_name in "ads_post,blondinka,channel_sync,group_post,old_views_booster,reaction_booster,subscribers_booster,view_booster,daily_pinning" %}
                      {% if p.container_name == "group_post" %}
                        <a href="{% url 'admin_panel:entity_post_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "ads_post" %}
                        <a href="{% url 'admin_panel:ads_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "blondinka" %}
                        <a href="{% url 'admin_panel:blondinka_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "channel_sync" %}
                        <a href="{% url 'admin_panel:channel_sync_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "old_views_booster" %}
                        <a href="{% url 'admin_panel:old_views_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "reaction_booster" %}
                        <a href="{% url 'admin_panel:reaction_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "subscribers_booster" %}
                        <a href="{% url 'admin_panel:subscribers_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "view_booster" %}
                        <a href="{% url 'admin_panel:view_boost_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% elif p.container_name == "daily_pinning" %}
                        <a href="{% url 'admin_panel:daily_pinning_tasks_view' %}" title="Задачи">
                          <img src="{% static 'admin_panel/img/search.png' %}" alt="Открыть" class="icon-16">
                        </a>&nbsp;
                      {% endif %}
                    {% endif %}

                    <!-- Управление состоянием контейнера -->
                    {% if p.docker_status == "running" %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'stop' %}" title="Остановить">
                        <img src="{% static 'admin_panel/img/stop.png' %}" alt="Остановить" class="icon-16">
                      </a>&nbsp;
                      <a href="{% url 'admin_panel:plugin_action' p.id 'restart' %}" title="Перезагрузить">
                        <img src="{% static 'admin_panel/img/reload.png' %}" alt="Перезагрузить" class="icon-16">
                      </a>
                    {% else %}
                      <a href="{% url 'admin_panel:plugin_action' p.id 'start' %}" title="Запустить">
                        <img src="{% static 'admin_panel/img/start.png' %}" alt="Запустить" class="icon-16">
                      </a>
                    {% endif %}
                    
                    <!-- Логи -->
                    &nbsp;<a href="{% url 'admin_panel:plugin_logs' p.id %}" title="Логи">
                      <img src="{% static 'admin_panel/img/logs.png' %}" alt="Логи" class="icon-16">
                    </a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-muted text-center">Нет плагинов</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";

  initSortableTables();
  initTablePagination(20); // 20 строк на страницу
</script>

<script>
  {{ block.super }}
  $(function () {
    // 1) Находим ветку "Плагины" в сайдбаре (иконка fa-plug) и раскрываем её
    const $pluginsTree = $('.main-sidebar .nav-item.has-treeview')
      .has('.nav-link .fa-plug');
    if ($pluginsTree.length) {
      $pluginsTree.addClass('menu-open');                    // помечаем как открытую
      $pluginsTree.children('.nav-treeview').css('display','block'); // показываем подменю
      // Сообщаем AdminLTE, что ветка раскрыта — это вызовет твой adjustSidebar()
      $(document).trigger('expanded.lte.treeview');
    }

    // 2) При переключении вкладок пересчитываем ещё раз через стандартные события
    $('a[data-toggle="tab"]').on('shown.bs.tab', function () {
      // триггерим то же событие, на которое уже подписан базовый код
      $(document).trigger('expanded.lte.treeview');
    });

    // 3) На всякий случай — первый пересчёт после первичной отрисовки
    setTimeout(function () {
      $(document).trigger('expanded.lte.treeview');
    }, 300);
  });
</script>
{% endblock %}