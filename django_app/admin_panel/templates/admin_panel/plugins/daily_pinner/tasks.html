{% extends "adminlte/base.html" %}
{% load static %}
{% load filters %}

{% block content %}
<section class="content">
  <div class="container-fluid">

    <!-- Заголовок и шестерёнка -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">{{ page_title }}</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <!-- Кнопка "Добавить" -->
    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'admin_panel:daily_pinning_task_add' %}" class="btn btn-add">
        <i class="fas fa-plus"></i> Добавить
      </a>
    </div>

    <!-- Таблица -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="dailyPinnerTable" data-sortable data-paginate>
        <thead>
          <tr>
            <th>ID</th>
            <th class="col-status">Статус</th>
            <th>Канал</th>
            <th>Интервал</th>
            <th>Закреп</th>
            <th>Лента</th>
            <th>Вчера всего</th>
            <th>Вчера пустых</th>
            <th>Сегодня всего</th>
            <th>Сегодня пустых</th>
            <th>Действия</th>
          </tr>
        </thead>

        <tbody>
          {% for t in tasks %}
          <tr>
            <!-- ID -->
            <td class="text-center">{{ t.id }}</td>

            <!-- Статус -->
            <td class="col-status text-center">
              {% if t.is_active %}
                <span class="status-dot active" title="Активна"></span>
              {% else %}
                <span class="status-dot inactive" title="Неактивна"></span>
              {% endif %}
            </td>

            <!-- Канал -->
            <td>{{ t.channel.name|default:"—" }}</td>

            <!-- Интервал -->
            <td class="text-center">
              {% if t.start_time and t.end_time %}
                {% if t.start_time|time:"H:i" == "08:00" and t.end_time|time:"H:i" == "18:00" %}
                  Все
                {% else %}
                  {{ t.start_time|time:"H:i" }}–{{ t.end_time|time:"H:i" }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>

            <!-- Закреп -->
            <td class="text-center">{{ t.unpin_after_minutes|default_if_none:"-" }} мин</td>

            <!-- Лента -->
            <td class="text-center">{{ t.delete_notification_after_minutes|default_if_none:"—" }} мин</td>

            <!-- Вчера всего -->
            <td class="text-center">{{ t.total_yesterday|default_if_none:0|add:t.dummy_yesterday|default_if_none:0 }}</td>

            <!-- Вчера пустых -->
            <td class="text-center">{{ t.dummy_yesterday|default_if_none:"0" }}</td>

            <!-- Сегодня всего -->
            <td class="text-center">{{ t.total_today|default_if_none:"0"|add:t.dummy_today|default_if_none:"0" }}</td>

            <!-- Сегодня пустых -->
            <td class="text-center">{{ t.dummy_today|default_if_none:"0" }}</td>

            <!-- Действия -->
            <td class="text-center text-nowrap">
              <a href="{% url 'admin_panel:daily_pinning_task_edit' t.id %}" title="Редактировать">
                <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать" class="icon-16 mr-2">
              </a>

              <form method="post" action="{% url 'admin_panel:daily_pinning_task_delete' t.id %}"
                    style="display:inline;" onsubmit="return confirm('Удалить задачу #{{ t.id }}?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-link p-0 m-0" title="Удалить">
                  <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16">
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted">Задачи отсутствуют</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

<!-- JS -->
<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";

  initSortableTables();
  initTablePagination(20);
</script>

{% endblock %}