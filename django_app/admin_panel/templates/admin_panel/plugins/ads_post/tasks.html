{% extends "adminlte/base.html" %}
{% load static %}
{% load filters %}

{% block content %}
<section class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">Постинг рекламы 1-24</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'admin_panel:ads_task_add' %}" class="btn btn-add">
        <i class="fas fa-plus"></i> Добавить
      </a>
    </div>

    {% if api_error %}
      <div class="alert alert-danger">{{ api_error }}</div>
    {% endif %}

    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="adsTable" data-sortable data-paginate>
        <thead>
          <tr>
            <th>ID</th>
            <th>Статус</th>
            <th>Заказчик</th>
            <th>Где рекламируем</th>
            <th>Дата и Время</th>
            <th>Оплата</th>
            <th>Закреп</th>
            <th>Лента</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for t in task_groups %}
          <tr>
            <td>{{ t.id }}</td>

            <!-- Статус -->
            <td class="text-center">
              {% if t.is_active %}
                <span class="status-dot active" title="Активна"></span>
              {% else %}
                <span class="status-dot inactive" title="Неактивна"></span>
              {% endif %}
            </td>

            <!-- Заказчик -->
            <td>{{ t.name }}</td>

            <!-- Цель -->
            <td>{{ t.target }}</td>

            <!-- Дата публикации -->
            <td>
              {% if t.publish_at %}
                {{ t.publish_at|date:"d.m.Y H:i" }}
              {% else %}
                —
              {% endif %}
            </td>

            <!-- Оплата -->
            <td class="text-center">
              {% if t.is_paid %}
                <span class="status-dot active" title="Оплачено"></span>
              {% else %}
                <span class="status-dot inactive" title="Не оплачено"></span>
              {% endif %}
            </td>

            <!-- Закреп -->
            <td class="text-center">
              {% with now=time_now|default:None %}
                {% if t.published_at and not t.unpinned_at and now|timesince:t.published_at > "01:10:00" %}
                  <span class="status-dot red" title="Просрочено"></span>
                {% elif t.pinned_at and t.unpinned_at %}
                  <span class="status-dot green" title="Выполнено"></span>
                {% elif t.published_at and not t.unpinned_at %}
                  <span class="status-dot blue" title="В процессе"></span>
                {% else %}
                  <span class="status-dot gray" title="Ожидание публикации"></span>
                {% endif %}
              {% endwith %}
            </td>

            <!-- Лента -->
            <td class="text-center">
              {% with now=time_now|default:None %}
                {% if t.published_at and not t.deleted_at and now|timesince:t.published_at > "24:10:00" %}
                  <span class="status-dot red" title="Просрочено"></span>
                {% elif t.published_at and t.deleted_at %}
                  <span class="status-dot green" title="Выполнено"></span>
                {% elif t.published_at and not t.deleted_at %}
                  <span class="status-dot blue" title="В процессе"></span>
                {% else %}
                  <span class="status-dot gray" title="Ожидание публикации"></span>
                {% endif %}
              {% endwith %}
            </td>

            <!-- Действия -->
            <td class="text-center">
              <a href="{% url 'admin_panel:ads_task_edit' t.id %}" title="Редактировать">
                <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать" class="icon-16 mr-2">
              </a>
              <a href="{% url 'admin_panel:ads_task_edit' t.id %}" title="Удалить">
                <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16">
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted">Рекламные задачи отсутствуют</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";
  initSortableTables();
  initTablePagination(25);
</script>
{% endblock %}
