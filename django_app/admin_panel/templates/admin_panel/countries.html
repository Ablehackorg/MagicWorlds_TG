{% extends "adminlte/base.html" %}
{% load static %}
{% block content %}
<section class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">Страны</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <div class="d-flex justify-content-end mb-3">
      <button id="showAddBtn" class="btn btn-add"><i class="fas fa-plus"></i> Добавить</button>
    </div>

    <!-- Добавление -->
    <div id="addPanel" class="card mb-4" style="display:none;">
      <div class="card-header"><h3 class="card-title">Новая страна</h3></div>
      <div class="card-body">
        <form id="addForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="name">Название</label>
            <input type="text" name="name" id="name" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Смещение часового пояса (относительно МСК)</label>
            <div class="d-flex">
              <select name="tz_sign" class="form-control mr-2">
                <option value="+">+</option>
                <option value="-">-</option>
              </select>
              <input type="number" name="tz_hours" class="form-control mr-2" min="0" max="14" value="0" required>
              <input type="number" name="tz_minutes" class="form-control" min="0" max="59" step="15" value="0" required>
            </div>
          </div>
          <div class="mt-3 text-right">
            <button type="submit" class="btn btn-success">Сохранить</button>
            <button type="button" id="cancelAddBtn" class="btn btn-secondary">Отмена</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Редактирование -->
    <div id="editPanel" class="card mb-4" style="display:none;">
      <div class="card-header"><h3 class="card-title">Редактирование страны</h3></div>
      <div class="card-body">
        <div id="editPane"></div>
        <div class="mt-3 text-right">
          <button id="saveEditBtn" class="btn btn-success">Сохранить</button>
          <button id="cancelEditBtn" class="btn btn-secondary">Отмена</button>
        </div>
      </div>
    </div>

    <!-- Таблица -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover" 
             id="countriesTable" data-sortable data-paginate>
        <colgroup>
          <col style="width:70px">
          <col>
          <col style="width:120px">
          <col style="width:90px">
        </colgroup>
        <thead>
          <tr>
            <th data-type="number">ID</th>
            <th data-type="text">Название</th>
            <th data-type="text">Смещение</th>
            <th class="no-sort" data-sortable="false">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for c in countries %}
          <tr data-id="{{ c.id }}">
            <td>{{ c.id }}</td>
            <td class="country-name">{{ c.name }}</td>
            <td class="country-delta">{{ c.delta_str }}</td>
            <td class="text-center">
              <a href="#" class="edit-link" data-id="{{ c.id }}">
                <img src="{% static 'admin_panel/img/edit.png' %}" alt="Редактировать" class="icon-16">
              </a>
              <a href="#" class="delete-link" data-id="{{ c.id }}">
                <img src="{% static 'admin_panel/img/delete.png' %}" alt="Удалить" class="icon-16">
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

<script type="module">
  import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
  import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
  import "{% static 'admin_panel/js/colToggles.js' %}";

  initSortableTables();
  initTablePagination(20);
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;
  const tbody = document.querySelector("#countriesTable tbody");

  // Добавление
  const addPanel = document.getElementById("addPanel");
  document.getElementById("showAddBtn").onclick = () => { addPanel.style.display = "block"; };
  document.getElementById("cancelAddBtn").onclick = () => { addPanel.style.display = "none"; };

  document.getElementById("addForm").onsubmit = async (e) => {
    e.preventDefault();
    const data = new FormData(e.target);

    try {
      const resp = await fetch("{% url 'admin_panel:country_add_ajax' %}", {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken},
        body: data
      });
      if (!resp.ok) throw new Error("Ошибка при добавлении");
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  };

  // Редактирование
  const editPanel = document.getElementById("editPanel");
  const editPane = document.getElementById("editPane");

  tbody.addEventListener("click", async (e) => {
    const editEl = e.target.closest(".edit-link");
    const delEl = e.target.closest(".delete-link");

    if (editEl) {
      e.preventDefault();
      const tr = editEl.closest("tr");
      const id = tr.dataset.id;
      const name = tr.querySelector(".country-name").textContent;
      const deltaStr = tr.querySelector(".country-delta").textContent.trim();

      const sign = deltaStr.startsWith("-") ? "-" : "+";
      const [hh, mm] = deltaStr.slice(1).split(":");

      editPane.innerHTML = `
        <div class="form-group">
          <label>Название</label>
          <input type="text" class="form-control edit-input-name" data-id="${id}" value="${name}">
        </div>
        <div class="form-group mt-2">
          <label>Смещение часового пояса</label>
          <div class="d-flex">
            <select class="form-control mr-2 edit-input-sign" data-id="${id}">
              <option value="+" ${sign==="+"?"selected":""}>+</option>
              <option value="-" ${sign==="-"?"selected":""}>-</option>
            </select>
            <input type="number" class="form-control mr-2 edit-input-hours" data-id="${id}" min="0" max="14" value="${parseInt(hh)}">
            <input type="number" class="form-control edit-input-minutes" data-id="${id}" min="0" max="59" step="15" value="${parseInt(mm)}">
          </div>
        </div>
      `;
      editPanel.style.display = "block";
    }

    if (delEl) {
      e.preventDefault();
      const id = delEl.dataset.id;
      if (!confirm("Удалить страну?")) return;
      try {
        const resp = await fetch(`/countries/${id}/delete/`, {
          method: "POST",
          headers: {"X-CSRFToken": csrftoken}
        });
        if (!resp.ok) throw new Error("Ошибка при удалении");
        location.reload();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  document.getElementById("cancelEditBtn").onclick = () => { editPanel.style.display = "none"; };

  document.getElementById("saveEditBtn").onclick = async () => {
    try {
      const id = editPane.querySelector(".edit-input-name").dataset.id;
      const name = editPane.querySelector(".edit-input-name").value;
      const tz_sign = editPane.querySelector(".edit-input-sign").value;
      const tz_hours = editPane.querySelector(".edit-input-hours").value;
      const tz_minutes = editPane.querySelector(".edit-input-minutes").value;

      const resp = await fetch(`/countries/${id}/update/`, {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken},
        body: new URLSearchParams({name, tz_sign, tz_hours, tz_minutes})
      });
      if (!resp.ok) throw new Error("Ошибка при сохранении");
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  };
});
</script>
{% endblock %}
