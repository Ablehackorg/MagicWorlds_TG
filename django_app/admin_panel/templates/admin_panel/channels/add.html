{% extends "adminlte/base.html" %}
{% load static %}
{% block content %}
<section class="content">
  <div class="container-fluid">
    <h1 class="mb-4">Добавить канал</h1>

    <form method="post" id="addChannelForm" enctype="multipart/form-data"
          action="{% url 'admin_panel:channels_add' %}">
      {% csrf_token %}

      <div class="mb-3">
        <button type="button" id="autoFillBtn" class="btn btn-secondary">Заполнить автоматически</button>
      </div>

      <div class="row">
        <!-- Левая колонка -->
        <div class="col-md-6">
          <div class="form-group" id="linkWrapper">
            <label for="link">Ссылка на канал</label>
            <input type="text" name="link" id="link" class="form-control"
                   placeholder="https://t.me/example или @example" required>
          </div>

          <div class="form-group">
            <label for="telegram_id">Telegram ID</label>
            <input type="number" step="1" name="telegram_id" id="telegram_id" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="name">Название</label>
            <input type="text" name="name" id="name" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="description">Описание</label>
            <textarea name="description" id="description" class="form-control" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="country">Страна</label>
            <select name="country" id="country" class="form-control">
              <option value="">— Не выбрано —</option>
              {% for c in countries %}
                <option value="{{ c.name }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Правая колонка -->
        <div class="col-md-6">
          <div class="form-group">
            <label for="category">Категория</label>
            <select name="category" id="category" class="form-control">
              <option value="">— Не выбрано —</option>
              {% for c in categories %}
                <option value="{{ c.name }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="owner">Владелец</label>
            <select name="owner" id="owner" class="form-control">
              <option value="">— Не выбрано —</option>
              {% for o in owners %}
                <option value="{{ o }}">{{ o }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="destination_type">Тип</label>
            <select name="destination_type" id="destination_type" class="form-control">
              <option value="">— Не выбрано —</option>
              {% for d in destination_types %}
                <option value="{{ d }}">{{ d }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="text_suffix">Текст-суффикс (добавляется в конец каждого поста)</label>
            <textarea name="text_suffix" id="text_suffix" class="form-control" rows="4"
                      placeholder="Например:&#10;— Подпишись: @mychannel&#10;— Реклама: @ads_contact"></textarea>
            <small class="form-text text-muted">Можно оставить пустым. Будет добавлен как отдельный блок после исходного текста/подписи.</small>
          </div>

          <div class="form-group" id="photoWrapper">
            <label for="photo">Картинка</label>
            <div class="image-upload" style="max-width:250px;">
              <input type="file" name="photo" id="photo" class="d-none" accept="image/*">
              <div id="preview" class="preview-box d-flex align-items-center justify-content-center">
                <span class="text-muted">Нет изображения</span>
              </div>
              <div class="mt-2 d-flex" style="gap:8px;">
                <button type="button" class="btn btn-sm btn-outline-primary" id="pickPhotoBtn">Загрузить</button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="clearPhotoBtn" disabled>Очистить</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success">Сохранить</button>
      <a href="{% url 'admin_panel:channels_page' %}" class="btn btn-outline-secondary">Отмена</a>
    </form>

  </div>
</section>

<script>
(function () {
  const photoInput = document.getElementById('photo');
  const previewBox = document.getElementById('preview');
  const pickBtn    = document.getElementById('pickPhotoBtn');
  const clearBtn   = document.getElementById('clearPhotoBtn');
  const PARSER_URL = (window.API && window.API.PARSER) || "/api/parse_channel";

  // превью
  function showPreview(src){
    previewBox.innerHTML = `<img src="${src}" alt="preview"
        style="width:100%;height:100%;object-fit:cover;">`;
    clearBtn.disabled = false;
  }
  function clearPreview(){
    if (photoInput) photoInput.value = '';
    previewBox.innerHTML = `<span class="text-muted">Нет изображения</span>`;
    clearBtn.disabled = true;
  }

  if (photoInput) {
    photoInput.addEventListener('change', ev => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return clearPreview();
      const r = new FileReader();
      r.onload = e2 => showPreview(e2.target.result);
      r.readAsDataURL(f);
    });
  }
  if (pickBtn)  pickBtn.addEventListener('click', () => photoInput.click());
  if (clearBtn) clearBtn.addEventListener('click', clearPreview);
  previewBox.addEventListener('click', () => photoInput.click());

  // автозаполнение
  document.getElementById("autoFillBtn").addEventListener("click", async () => {
    const linkEl = document.getElementById("link");
    const idEl   = document.getElementById("telegram_id");
    const nameEl = document.getElementById("name");
    const descEl = document.getElementById("description");

    const link = linkEl.value.trim();
    if (!link) return alert("Введите ссылку для автозаполнения");

    try {
      const resp = await fetch(PARSER_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || data.error || "Ошибка API");

      idEl.value   = data.telegram_id ?? data.tg_id ?? "";
      nameEl.value = data.name || "";
      if (data.description) descEl.value = data.description;

      // блокировка редактирования
      linkEl.readOnly = true;
      idEl.readOnly   = true;
      descEl.readOnly = true;
      nameEl.readOnly = true;

      function setSelectByText(selId, text) {
        const sel = document.getElementById(selId);
        const val = (text||"").trim().toLowerCase();
        if (!sel || !val) return;
        for (const opt of sel.options) {
          if (opt.value.trim().toLowerCase() === val || opt.textContent.trim().toLowerCase() === val) {
            opt.selected = true; return;
          }
        }
        const opt = document.createElement('option');
        opt.value = text; opt.textContent = text; opt.selected = true;
        sel.insertBefore(opt, sel.firstChild);
      }
      if (data.country)  setSelectByText("country",  data.country);
      if (data.category) setSelectByText("category", data.category);

      // картинка
      if (data.photo) {
        const photoUrl = data.photo;
        showPreview(photoUrl);

        // подсовываем в input как файл
        try {
          const imgResp = await fetch(photoUrl);
          if (imgResp.ok) {
            const rawCT = (imgResp.headers.get("content-type") || "").split(";")[0].trim().toLowerCase();
            if (rawCT.startsWith("image/")) {
              const buf = await imgResp.arrayBuffer();
              const ext = (rawCT.split("/")[1] || "jpg").replace(/[^a-z0-9]/gi, "");
              const file = new File([buf], `autofill.${ext}`, { type: rawCT });
              const dt = new DataTransfer();
              dt.items.add(file);
              photoInput.files = dt.files;

              // блокировка ручной загрузки
              photoInput.style.display = "none";  // скрыть, но не выключать
              pickBtn.disabled = true;
              clearBtn.disabled = true;
              previewBox.onclick = null;

            }
          }
        } catch (err) {
          console.warn("Ошибка загрузки фото:", err);
        }
      } else {
        clearPreview();
      }
    } catch (e) {
      alert("Автозаполнение не удалось: " + e.message);
    }
  });
})();
</script>
{% endblock %}
