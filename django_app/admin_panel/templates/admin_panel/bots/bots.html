{% extends "adminlte/base.html" %}
{% load static %}

{% block content %}
<section class="content">
  <div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1 class="mb-0">Управление ботами</h1>
      <span class="col-toggle-btn" title="Управление столбцами">
        <i class="fas fa-cog"></i>
      </span>
    </div>

    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'admin_panel:add_bot' %}" class="btn btn-add">
        <i class="fas fa-plus"></i> Добавить бота
      </a>
      <button id="syncAllBtn" class="btn btn-primary ml-2">
        <i class="fas fa-sync-alt"></i> Синхронизировать все
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover"
             id="botsTable"
             data-sortable
             data-paginate>
        <thead>
          <tr>
            <th data-type="number">ID</th>
            <th>Аватар</th>
            <th data-type="text">Имя</th>
            <th data-type="text">Телефон</th>
            <th data-type="text">Статус</th>
            <th data-type="text">TG Инфо</th>
            <th class="no-sort" data-sortable="false">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for bot in bots %}
          <tr>
            <td>{{ bot.id }}</td>

            <td class="text-center">
              {% if bot and bot.avatar.url %}
                <img src="{{ bot.avatar.url }}"
                     class="img-thumbnail rounded-circle"
                     style="width:40px;height:40px;object-fit:cover">
              {% else %}
                <div class="avatar-placeholder rounded-circle d-inline-flex
                            align-items-center justify-content-center bg-light"
                     style="width:40px;height:40px;border:1px solid #dee2e6">
                  <i class="fas fa-user text-muted"></i>
                </div>
              {% endif %}
            </td>

            <td>
              <strong>{{ bot.first_name|default:"—" }}</strong>
              {% if bot.last_name %}
                <br><small class="text-muted">{{ bot.last_name }}</small>
              {% endif %}
            </td>

            <td>{{ bot.phone|default:"—" }}</td>

            <td class="text-center">
              {% if bot.is_banned %}
                <span class="badge badge-danger">Забанен</span>
              {% elif not bot.is_active %}
                <span class="badge badge-warning">Неактивен</span>
              {% elif bot.last_sync_at %}
                <span class="badge badge-success">Активен</span>
              {% else %}
                <span class="badge badge-secondary">Не проверен</span>
              {% endif %}
            </td>

            <td class="small">
              {% if bot.telegram_info %}
                {% if bot.telegram_info.username %}
                  <div><strong>@{{ bot.telegram_info.username }}</strong></div>
                {% endif %}
                {% if bot.telegram_info.last_seen %}
                  <div class="text-muted">
                    {{ bot.telegram_info.last_seen }}
                  </div>
                {% endif %}
              {% else %}
                <span class="text-muted">Нет данных</span>
              {% endif %}
            </td>

            <td class="text-center">
              {% if bot.phone %}
                <a href="https://t.me/{{ bot.phone }}"
                   target="_blank"
                   title="Открыть">
                  <img src="{% static 'admin_panel/img/search.png' %}" class="icon-16">
                </a>
              {% endif %}
              <a href="{% url 'admin_panel:bot_edit' bot.id %}" title="Редактировать">
                <img src="{% static 'admin_panel/img/edit.png' %}" class="icon-16">
              </a>
              <button class="delete-btn delete-link"
                      data-bot-id="{{ bot.id }}"
                      data-bot-name="{{ bot.first_name }} {{ bot.last_name }}"
                      title="Удалить">
                <img src="{% static 'admin_panel/img/delete.png' %}" class="icon-16">
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">
              Ботов пока нет
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

<script type="module">
import { initSortableTables } from "{% static 'admin_panel/js/sortableTable.js' %}";
import { initTablePagination } from "{% static 'admin_panel/js/pagination.js' %}";
import "{% static 'admin_panel/js/colToggles.js' %}";

initSortableTables();
initTablePagination(20);
</script>

{% endblock %}
