# Generated by Django 5.2.6 on 2025-09-27 18:23

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Category',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
                'verbose_name_plural': '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Country',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': '–°—Ç—Ä–∞–Ω–∞',
                'verbose_name_plural': '–°—Ç—Ä–∞–Ω—ã',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Plugin',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('slug', models.SlugField(unique=True)),
                ('description', models.TextField(blank=True)),
                ('category', models.CharField(choices=[('group', '–ü—É–±–ª–∏–∫–∞—Ç–æ—Ä –≤ –≥—Ä—É–ø–ø—É'), ('channel', '–ü—É–±–ª–∏–∫–∞—Ç–æ—Ä –≤ –∫–∞–Ω–∞–ª')], max_length=20)),
                ('container_name', models.CharField(max_length=100)),
                ('is_active', models.BooleanField(default=False)),
            ],
        ),
    ]
# Generated by Django 5.2.6 on 2025-10-02 00:44

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('admin_panel', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='country',
            name='time_zone_delta',
            field=models.IntegerField(default=0),
            preserve_default=False,
        ),
    ]
# Generated by Django 5.2.6 on 2025-10-02 12:02

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('admin_panel', '0002_country_time_zone_delta'),
    ]

    operations = [
        migrations.AlterField(
            model_name='country',
            name='time_zone_delta',
            field=models.FloatField(default=0.0, help_text='–°–º–µ—â–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ú–°–ö (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏ –¥—Ä–æ–±–Ω—ã–º)'),
        ),
    ]
# admin_panel/templatetags/custom_filters.py
from django import template
from django.utils import timezone
from django.utils.safestring import mark_safe

register = template.Library()

@register.filter
def get_item(obj, key):
    if isinstance(obj, dict):
        return obj.get(key)
    # –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ ‚Äî –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ getattr
    return getattr(obj, key, None)

@register.filter
def seconds_to_hours(seconds):
    try:
        return int(seconds) // 3600
    except:
        return 0

@register.filter
def seconds_to_minutes(seconds):
    try:
        return (int(seconds) % 3600) // 60
    except:
        return 0

@register.filter
def add_hours(value, hours):
    if value:
        return value + timezone.timedelta(hours=hours)
    return value

@register.filter
def absolute(value):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–±—Å–æ–ª—é—Ç: –ø—Ä–æ—Å—Ç–æ math.fabs, –±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –±–µ–∑ –∑–Ω–∞–∫–∞.
    """
    try:
        # int —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã 5.0 –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞–ª–æ—Å—å –≤ '5.0'
        return abs(int(value))
    except (TypeError, ValueError):
        try:
            return abs(float(value))
        except (TypeError, ValueError):
            return value


@register.filter(is_safe=True)
def signed_delta_html(value):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π HTML —Å–æ —Å—Ç–∏–ª—è–º–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞–∫–∞:
    >0  ‚Üí –∑–µ–ª—ë–Ω—ã–π –∂–∏—Ä–Ω—ã–π, —Å –ø–ª—é—Å–æ–º
    <0  ‚Üí –∫—Ä–∞—Å–Ω—ã–π, —Å–æ –∑–Ω–∞–∫–æ–º –º–∏–Ω—É—Å
    =0  ‚Üí —Å–µ—Ä—ã–π 0

    –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
    <span class="text-success font-weight-bold">+12</span>
    <span class="text-danger">-7</span>
    <span class="text-muted">0</span>

    mark_safe –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –≥–µ–Ω–µ—Ä–∏–º span –≤—Ä—É—á–Ω—É—é.
    """
    try:
        num = int(value)
    except (TypeError, ValueError):
        # –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —á–∏—Å–ª–æ ‚Äî –≤–µ—Ä–Ω—ë–º –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        return value

    if num > 0:
        return mark_safe(f'<span class="text-success font-weight-bold">+{num}</span>')
    elif num < 0:
        # —Ç—É—Ç —É–∂–µ –º–∏–Ω—É—Å –µ—Å—Ç—å –≤ —Å–∞–º–æ–º —á–∏—Å–ª–µ, –æ—Ç–¥–µ–ª—å–Ω—É—é "‚àí" –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
        return mark_safe(f'<span class="text-danger">{num}</span>')
    else:
        return mark_safe('<span class="text-muted">0</span>')


@register.filter
def divisibleby(value, arg):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–ª–∏—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞."""
    try:
        return int(value) % int(arg) == 0
    except (TypeError, ValueError, ZeroDivisionError):
        return False


@register.filter
def human_minutes_or_hours(minutes):
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
    - –µ—Å–ª–∏ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 60 –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞ ‚Üí —á–∞—Å—ã
    - –∏–Ω–∞—á–µ ‚Üí –º–∏–Ω—É—Ç—ã
    """
    try:
        m = int(minutes)
        if m % 60 == 0:
            return f"{m // 60} —á–∞—Å"
        return f"{m} –º–∏–Ω"
    except (TypeError, ValueError):
        return "‚Äî"

@register.filter
def interval_display(value):
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤ –º–∏–Ω—É—Ç–∞—Ö) –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
    - –µ—Å–ª–∏ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 60 ‚Üí —á–∞—Å—ã
    - –∏–Ω–∞—á–µ ‚Üí –º–∏–Ω—É—Ç—ã
    """
    try:
        val = int(value)
        if val % 60 == 0:
            hours = val // 60
            return f"{hours} —á–∞—Å"
        return f"{val} –º–∏–Ω"
    except (TypeError, ValueError):
        return "‚Äî"
import logging
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_http_methods
from django.contrib import messages
from django.utils import timezone
from django.urls import reverse
from django.http import HttpResponseBadRequest
from django.db import transaction

import time
from datetime import datetime

from api.models import AdsOrder, MainEntity
from telegram.models import BotSession

log = logging.getLogger(__name__)


# ============================================================
#   –°–ü–ò–°–û–ö –†–ï–ö–õ–ê–ú–ù–´–• –ó–ê–î–ê–ß
# ============================================================
@login_required
def ads_tasks_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∑–∞–¥–∞—á."""
    try:
        tasks = (
            AdsOrder.objects
            .select_related("target", "bot")
            .order_by("-ordered_at")
        )
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∑–∞–¥–∞—á")
        return render(request, "admin_panel/plugins/ads_post/tasks.html", {
            "api_error": str(e),
            "tasks": [],
        })

    task_groups = []
    for t in tasks:
        task_groups.append({
            "id": t.id,
            "is_active": t.is_active,
            "name": t.name,
            "target": getattr(t.target, "name", "‚Äî"),
            "publish_at": t.publish_at,
            "is_paid": t.is_paid,
            "pinned_at": t.pinned_at,
            "unpinned_at": t.unpinned_at,
            "published_at": t.published_at,
            "deleted_at": t.deleted_at,
            "time_now": datetime.fromtimestamp(time.time()) 
        })

    return render(request, "admin_panel/plugins/ads_post/tasks.html", {
        "task_groups": task_groups,
    })


# ============================================================
#   –î–û–ë–ê–í–õ–ï–ù–ò–ï / –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================
@login_required
@require_http_methods(["GET", "POST"])
def ads_task_add(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–µ–∫–ª–∞–º–Ω–æ–π –∑–∞–¥–∞—á–∏."""
    if request.method == "POST":
        return _handle_ads_form(request)
    return _render_ads_form(request, None, "admin_panel/plugins/ads_post/task_create.html")


@login_required
@require_http_methods(["GET", "POST"])
def ads_task_edit(request, task_id: int):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∑–∞–¥–∞—á–∏."""
    task = get_object_or_404(AdsOrder, pk=task_id)
    if request.method == "POST":
        return _handle_ads_form(request, task)
    
    # –í—ã—á–∏—Å–ª—è–µ–º –ø–ª–∞–Ω–æ–≤—ã–µ –¥–∞—Ç—ã –¥–ª—è –∂—É—Ä–Ω–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    planned_pin_end = task.publish_at + timezone.timedelta(hours=1) if task.publish_at else None
    planned_feed_end = task.publish_at + timezone.timedelta(hours=24) if task.publish_at else None
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ MainEntity –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    entities = MainEntity.objects.all().order_by("name")
    
    return _render_ads_form(request, task, "admin_panel/plugins/ads_post/task_edit.html", {
        'planned_pin_end': planned_pin_end,
        'planned_feed_end': planned_feed_end,
        'entities': entities,
        'time_now': datetime.fromtimestamp(time.time()) 
    })


def _handle_ads_form(request, task=None):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)."""
    try:
        with transaction.atomic():
            post = request.POST
            files = request.FILES
            
            # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            name = post.get("name", "").strip()
            customer_status = post.get("customer_status", "new")
            customer_telegram = post.get("customer_telegram", "").strip()
            customer_fullname = post.get("customer_fullname", "").strip()
            notify_customer = bool(post.get("notify_customer"))
            notify_admin = bool(post.get("notify_admin"))
            is_paid = bool(post.get("is_paid"))
            is_active = bool(post.get("is_active"))
            post_link = post.get("post_link", "").strip()
            
            # –î–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ß—Ç–æ —Ä–µ–∫–ª–∞–º–∏—Ä—É–µ–º)
            source_link = post.get("source_link", "").strip()
            source_telegram_id = post.get("source_telegram_id", "").strip()
            source_name = post.get("source_name", "").strip()
            source_description = post.get("source_description", "").strip()
            source_photo = files.get("source_photo")
            
            # –í—ã–±–æ—Ä —Ü–µ–ª–∏ (MainEntity) –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            target_id = post.get("target_id")
            if not target_id:
                messages.error(request, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª/–≥—Ä—É–ø–ø—É –¥–ª—è —Ä–µ–∫–ª–∞–º—ã.")
                return redirect(request.path)
            
            try:
                target = MainEntity.objects.get(pk=target_id)
            except MainEntity.DoesNotExist:
                messages.error(request, "–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ü–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return redirect(request.path)

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞
            bot = BotSession.objects.filter(is_active=True).last()
            if not bot:
                messages.error(request, "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.")
                return redirect(request.path)

            # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç
            try:
                # –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (—Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è)
                ordered_date = post.get("ordered_date", "").strip()
                ordered_time = post.get("ordered_time", "").strip()
                if ordered_date and ordered_time:
                    ordered_at = timezone.make_aware(
                        timezone.datetime.strptime(f"{ordered_date} {ordered_time}", "%Y-%m-%d %H:%M")
                    )
                else:
                    ordered_at = datetime.fromtimestamp(time.time()) 
                
                # –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                publish_date = post.get("publish_date", "").strip()
                publish_time = post.get("publish_time", "").strip()
                if not publish_date or not publish_time:
                    messages.error(request, "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.")
                    return redirect(request.path)
                
                publish_at = timezone.make_aware(
                    timezone.datetime.strptime(f"{publish_date} {publish_time}", "%Y-%m-%d %H:%M")
                )
            except ValueError as e:
                messages.error(request, f"–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã: {e}")
                return redirect(request.path)

            # –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
            if not task:
                task = AdsOrder()
                messages.success(request, "–†–µ–∫–ª–∞–º–Ω–∞—è –∑–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.")
            else:
                messages.success(request, "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")

            # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∑–∞–¥–∞—á–∏
            task.name = name
            task.customer_status = customer_status
            task.customer_telegram = customer_telegram
            task.customer_fullname = customer_fullname
            task.notify_customer = notify_customer
            task.notify_admin = notify_admin
            task.target = target
            task.bot = bot
            task.ordered_at = ordered_at
            task.publish_at = publish_at
            task.is_paid = is_paid
            task.is_active = is_active
            task.post_link = post_link
            task.save()

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤ AdTargetEntity
            source_data = {
                'link': source_link,
                'telegram_id': int(source_telegram_id) if source_telegram_id else None,
                'name': source_name,
                'description': source_description,
                'entity_type': 'channel'  # –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º
            }
            task.update_source_data(source_data, source_photo)

    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º–Ω–æ–π –∑–∞–¥–∞—á–∏")
        messages.error(request, f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {str(e)}")
        return redirect(request.path)

    return redirect(reverse("admin_panel:ads_tasks_view"))

def _render_ads_form(request, task, template_name, extra_context=None):
    """–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ MainEntity –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    entities = MainEntity.objects.all().order_by("name")
    
    # –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–ª—É—á–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
    source_data = None
    if task and hasattr(task, 'source') and task.source:
        source_data = task.source
    
    context = {
        "task": task,
        "source": source_data,  # –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
        "entities": entities,
        "is_edit": bool(task),
        "time_now": datetime.fromtimestamp(time.time()) 
    }
    if extra_context:
        context.update(extra_context)
    return render(request, template_name, context)


# ============================================================
#   –£–î–ê–õ–ï–ù–ò–ï
# ============================================================
@login_required
@require_http_methods(["POST"])
def ads_task_delete(request, task_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∑–∞–¥–∞—á–∏."""
    try:
        task = get_object_or_404(AdsOrder, pk=task_id)
        task.delete()
        messages.success(request, f"–†–µ–∫–ª–∞–º–Ω–∞—è –∑–∞–¥–∞—á–∞ #{task_id} —É–¥–∞–ª–µ–Ω–∞.")
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏")
        return HttpResponseBadRequest(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {e}")

    return redirect("admin_panel:ads_tasks_view")import os
import logging
import requests
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_http_methods
from django.contrib import messages
from django.utils.timezone import now
from django.http import JsonResponse
from api.models import BoosterSettings, BoosterTariff, OldViewsTask

logger = logging.getLogger(__name__)

# üîπ –ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Twiboost
PROXY_URL = os.getenv("HTTP_PROXY") or os.getenv("HTTPS_PROXY")
PROXIES = {
    "http": PROXY_URL,
    "https": PROXY_URL,
} if PROXY_URL else None


def _safe_twiboost_get(endpoint, api_key):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Twiboost (services / balance –∏ –¥—Ä.) —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: ok, data, raw_excerpt, code
    """
    base_urls = [
        "https://twiboost.com/api/v2"
    ]

    headers = {
        "User-Agent": "Mozilla/5.0",
        "Accept": "application/json,text/plain,*/*",
    }

    for base in base_urls:
        try:
            full_url = f"{base}?action={endpoint}&key={api_key}"
            logger.debug("[_safe_twiboost_get] ‚Üí %s", full_url)

            r = requests.get(
                full_url,
                headers=headers,
                timeout=10,
                verify=False,
                proxies=PROXIES,
            )

            if r.status_code == 200:
                try:
                    data = r.json()
                    return True, data, r.text[:1000], r.status_code
                except Exception as e:
                    logger.warning("[_safe_twiboost_get] JSON parse error: %s", e)
                    continue
        except Exception as e:
            logger.warning("[_safe_twiboost_get] request failed (%s): %s", base, e)
            continue

    return False, None, "mock", 500


@login_required
@require_http_methods(["GET", "POST"])
def booster_settings_view(request):
    settings_obj = BoosterSettings.get_singleton()

    if request.method == "POST":
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        settings_obj.url = (request.POST.get("url") or "").strip()
        settings_obj.api_key = (request.POST.get("api_key") or "").strip()

        # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –º–æ–¥—É–ª–µ–π (—Ç–µ–ø–µ—Ä—å –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤ —Å–≤–∏—Ç—á–µ–π)
        settings_obj.is_active_old_views = request.POST.get("is_active_old_views") == "on"
        settings_obj.is_active_new_views = request.POST.get("is_active_new_views") == "on"
        settings_obj.is_active_subscribers = request.POST.get("is_active_subscribers") == "on"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        settings_obj.save()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
        _process_tariffs(request, settings_obj)

        messages.success(request, "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Å—Ç–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        return redirect("admin_panel:booster_settings")

    # –ü—Ä–∏ GET: –ø–æ–ª—É—á–∞–µ–º —Ç–∞—Ä–∏—Ñ—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
    tariffs_by_module = {
        "old_views": settings_obj.tariffs.filter(module="old_views"),
        "new_views": settings_obj.tariffs.filter(module="new_views"), 
        "subscribers": settings_obj.tariffs.filter(module="subscribers"),
    }

    # –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    active_channels = OldViewsTask.objects.filter(
        is_active=True
    ).select_related('target').values('target__id', 'target__name', 'is_active')

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ API
    api_ok = False
    if settings_obj.api_key:
        ok, data, raw_excerpt, code = _safe_twiboost_get("services", settings_obj.api_key)
        api_ok = bool(ok and isinstance(data, list))

    return render(request, "admin_panel/booster_settings.html", {
        "settings": settings_obj,
        "api_ok": api_ok,
        "tariffs": tariffs_by_module,
        "channels": active_channels,
    })


def _process_tariffs(request, settings_obj):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏–∑ —Ñ–æ—Ä–º—ã"""
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞—Ä–∏—Ñ—ã
    settings_obj.tariffs.all().delete()

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
    modules = ["old_views", "new_views", "subscribers"]
    
    for module in modules:
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
        tariff_count = 0
        for key in request.POST:
            if key.startswith(f"{module}_id_"):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ –∫–ª—é—á–∞ –≤–∏–¥–∞ "old_views_id_1"
                try:
                    num = int(key.split('_')[-1])
                    if num > tariff_count:
                        tariff_count = num
                except (ValueError, IndexError):
                    continue

        # –°–æ–∑–¥–∞–µ–º —Ç–∞—Ä–∏—Ñ—ã
        for i in range(1, tariff_count + 1):
            service_id = request.POST.get(f"{module}_id_{i}")
            min_limit = request.POST.get(f"{module}_min_{i}") 
            price_per_1000 = request.POST.get(f"{module}_tariff_{i}")
            is_active = request.POST.get(f"{module}_active_{i}") == "1"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
            if service_id and min_limit and price_per_1000:
                try:
                    BoosterTariff.objects.create(
                        booster=settings_obj,
                        module=module,
                        service_id=int(service_id),
                        min_limit=int(min_limit),
                        price_per_1000=float(price_per_1000),
                        is_active=is_active
                    )
                except (ValueError, TypeError) as e:
                    logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ {module}_{i}: {e}")
            elif service_id or min_limit or price_per_1000:
                # –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –Ω–æ –Ω–µ –≤—Å–µ - –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                logger.warning(f"–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ {module}_{i}: id={service_id}, min={min_limit}, price={price_per_1000}")


@login_required
def booster_check_ajax(request):
    """
    AJAX:
    - mode=status   ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API (services)
    - mode=balance  ‚Üí –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    –ï—Å–ª–∏ mode –Ω–µ —É–∫–∞–∑–∞–Ω, –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–±–∞ —à–∞–≥–∞.
    """
    settings_obj = BoosterSettings.get_singleton()
    api_key = settings_obj.api_key or ""
    mode = request.GET.get("mode", "")

    if not api_key:
        return JsonResponse({
            "status": "error",
            "balance": 0,
            "last_balance_check": None,
            "error": "API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        })

    resp = {
        "status": "ok",
        "balance": None,
        "last_balance_check": None,
        "error": None,
    }

    try:
        # === 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (services)
        if mode in ("", "status"):
            ok_services, data_services, raw_services, code_services = _safe_twiboost_get("services", api_key)
            status_ok = bool(ok_services and isinstance(data_services, list))
            if not status_ok:
                resp["status"] = "error"
                resp["error"] = f"–û—à–∏–±–∫–∞ API: –∫–æ–¥ {code_services}, –æ—Ç–≤–µ—Ç: {raw_services}"

        # === 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        if mode in ("", "balance"):
            ok_balance, data_balance, raw_balance, code_balance = _safe_twiboost_get("balance", api_key)
            if ok_balance and isinstance(data_balance, dict) and "balance" in data_balance:
                settings_obj.balance = float(data_balance["balance"])
                settings_obj.last_balance_check = now()
                settings_obj.save(update_fields=["balance", "last_balance_check"])
                resp["balance"] = settings_obj.balance
                resp["last_balance_check"] = settings_obj.last_balance_check.strftime("%d.%m.%Y %H:%M")
            else:
                resp["status"] = "error"
                resp["error"] = f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å: {raw_balance}"

    except Exception as e:
        logger.error("[booster_check_ajax] unexpected error: %s", e, exc_info=True)
        resp.update({
            "status": "error",
            "error": f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {str(e)}"
        })

    return JsonResponse(resp)


@login_required
def toggle_channel_status(request, channel_id):
    """–í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"""
    try:
        task = OldViewsTask.objects.get(target_id=channel_id)
        task.is_active = not task.is_active
        task.save()
        
        return JsonResponse({
            "success": True,
            "is_active": task.is_active
        })
    except OldViewsTask.DoesNotExist:
        return JsonResponse({
            "success": False,
            "error": "–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        }, status=404)


@login_required
def refresh_channels_list(request):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)"""
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
    # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    return JsonResponse({
        "success": True,
        "message": "–°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω"
    })# admin_panel/views/bots.py
from django.shortcuts import render
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse, HttpRequest
from django.views.decorators.http import require_POST
from django.db import transaction
import json

from telegram.models import BotSession


# ==================== Views: —Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ====================
@login_required
def bots_list(request: HttpRequest):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–æ—Ç–æ–≤.
    """
    bots = BotSession.objects.all().order_by("id")
    return render(request, "admin_panel/bots.html", {"bots": bots})

@login_required
def add_bot(request: HttpRequest):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞.
    """
    return render(request, "admin_panel/bots/add.html")


# ==================== Views: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ====================

@login_required
@require_POST
def update_bot(request: HttpRequest):
    """
    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞.
    –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: {"id": <bot_id>, "name": "–ù–æ–≤–æ–µ –∏–º—è"}.
    """
    try:
        data = json.loads(request.body.decode('utf-8'))
        bot_id = int(data.get('id'))
        name = (data.get('name') or "").strip()
        if not name:
            return JsonResponse({"success": False, "error": "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"}, status=400)

        bot = BotSession.objects.get(id=bot_id)
        bot.name = name
        bot.save(update_fields=["name"])
        return JsonResponse({"success": True})

    except BotSession.DoesNotExist:
        return JsonResponse({"success": False, "error": "–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"}, status=404)
    except Exception as e:
        return JsonResponse({"success": False, "error": str(e)}, status=400)


@login_required
@require_POST
def bulk_update_bots(request: HttpRequest):
    """
    –ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–≤.
    –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: {"items": [{"id": <id>, "name": "..."}, ...]}.
    """
    try:
        payload = json.loads(request.body.decode("utf-8"))
        items = payload.get("items") or []
        if not isinstance(items, list) or not items:
            return JsonResponse({"success": False, "error": "–ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π"}, status=400)

        updated = 0
        errors = []

        with transaction.atomic():
            for i, it in enumerate(items, start=1):
                try:
                    bot_id = int(it.get("id"))
                    name = (it.get("name") or "").strip()
                    if not name:
                        raise ValueError("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")

                    bot = BotSession.objects.select_for_update().get(id=bot_id)
                    bot.name = name
                    bot.save(update_fields=["name"])
                    updated += 1

                except BotSession.DoesNotExist:
                    errors.append({"index": i, "id": it.get("id"), "error": "–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"})
                except Exception as e:
                    errors.append({"index": i, "id": it.get("id"), "error": str(e)})

        # –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –Ω–æ —á–∞—Å—Ç—å –æ–±–Ω–æ–≤–∏–ª–æ—Å—å ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 207 (Multi-Status)
        code = 200 if updated and not errors else (207 if errors else 200)
        return JsonResponse({"success": True, "updated": updated, "errors": errors}, status=code)

    except Exception as e:
        return JsonResponse({"success": False, "error": str(e)}, status=400)


# ==================== –£–¥–∞–ª–µ–Ω–∏–µ ====================

@login_required
@require_POST
def delete_bot(request: HttpRequest, bot_id: int):
    """
    –£–¥–∞–ª–µ–Ω–∏–µ –±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –∏–∑ –ª–æ–∫–Ω–æ–π –ë–î.
    """
    try:
        with transaction.atomic():
            bot = BotSession.objects.select_for_update().get(id=bot_id)
            bot.delete()
        return JsonResponse({"success": True})
    except BotSession.DoesNotExist:
        return JsonResponse({"success": False, "error": "–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"}, status=404)
    except Exception as e:
        return JsonResponse({"success": False, "error": str(e)}, status=400)
# admin_panel/views/channels.py
import logging
from django.shortcuts import render, redirect, get_object_or_404
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required
from django.contrib import messages

from admin_panel.models import Country, Category
from api.models import MainChannel

from .config import destination_types, owners

log = logging.getLogger(__name__)


def _resolve_name(model, val):
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ –ø–æ id –∏–ª–∏ –ø–æ name.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ country/category –∏–∑ —Ñ–æ—Ä–º—ã.
    """
    if not val:
        return None
    s = str(val).strip()
    if s.isdigit():
        try:
            return model.objects.get(id=int(s))
        except model.DoesNotExist:
            return None
    try:
        return model.objects.get(name=s)
    except model.DoesNotExist:
        return None


# ---------- —Å–ø–∏—Å–æ–∫ ----------
@login_required
def channels_page_view(request):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤.
    """
    rows = MainChannel.objects.all().order_by("id")
    return render(request, "admin_panel/channels.html", {"channels": rows})


# ---------- –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ----------
@login_required
@require_http_methods(["GET", "POST"])
def channel_add_view(request):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
    GET  ‚Üí —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    POST ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ MainChannel
    """
    if request.method == "POST":
        name = (request.POST.get("name") or "").strip()
        link = (request.POST.get("link") or "").strip()
        tg_id_raw = (request.POST.get("telegram_id") or "").strip()
        country_val = request.POST.get("country") or request.POST.get("country_id")
        category_val = request.POST.get("category") or request.POST.get("category_id")
        owner = (request.POST.get("owner") or "").strip()
        destination_type = (request.POST.get("destination_type") or "").strip()
        description = (request.POST.get("description") or "").strip()
        text_suffix = (request.POST.get("text_suffix") or "").strip()

        try:
            telegram_id = int(tg_id_raw)
        except ValueError:
            messages.error(request, "Telegram ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
            return redirect("admin_panel:channels_page")

        channel = MainChannel(
            name=name,
            telegram_id=telegram_id,
            country=_resolve_name(Country, country_val),
            category=_resolve_name(Category, category_val),
            owner=owner,
            destination_type=destination_type,
            link=link,
            description=description,
            text_suffix=text_suffix,
            is_add_suffix=False,
        )

        if "photo" in request.FILES:
            channel.photo = request.FILES["photo"]

        channel.save()
        messages.success(request, f"–ö–∞–Ω–∞–ª {channel.name} —Å–æ–∑–¥–∞–Ω")
        return redirect("admin_panel:channels_page")

    # GET ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏–º —Ñ–æ—Ä–º—É
    return render(request, "admin_panel/channels/add.html", {
        "countries": Country.objects.all(),
        "categories": Category.objects.all(),
        "owners": owners,
        "destination_types": destination_types,
    })


# ---------- —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
@login_required
@require_http_methods(["GET", "POST"])
def channel_edit_view(request, chan_id: int):
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞.
    GET  ‚Üí —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    POST ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ MainChannel
    """
    channel = get_object_or_404(MainChannel, id=chan_id)

    if request.method == "POST":
        channel.name = (request.POST.get("name") or "").strip()
        channel.link = (request.POST.get("link") or "").strip()
        channel.tags = request.POST.get("tags") or ""
        channel.description = (request.POST.get("description") or "").strip()

        channel.country = _resolve_name(Country, request.POST.get("country"))
        channel.category = _resolve_name(Category, request.POST.get("category"))

        channel.owner = (request.POST.get("owner") or "").strip()
        channel.destination_type = (request.POST.get("destination_type") or "").strip()

        channel.text_suffix = (request.POST.get("text_suffix") or "").strip()
        channel.is_add_suffix = request.POST.get("is_add_suffix") == "1"

        if "photo" in request.FILES:
            channel.photo = request.FILES["photo"]

        channel.save()
        messages.success(request, f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–Ω–∞–ª–∞ #{chan_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        return redirect("admin_panel:channels_page")

    return render(request, "admin_panel/channels/edit.html", {
        "chan_id": chan_id,
        "channel": channel,
        "countries": Country.objects.all(),
        "categories": Category.objects.all(),
        "owners": owners,
        "destination_types": destination_types,
    })


# ---------- —É–¥–∞–ª–µ–Ω–∏–µ ----------
@login_required
@require_http_methods(["POST"])
def channel_delete_view(request, chan_id: int):
    """
    –£–¥–∞–ª—è–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª.
    """
    channel = get_object_or_404(MainChannel, id=chan_id)
    name = channel.name
    channel.delete()
    messages.success(request, f"–ö–∞–Ω–∞–ª {name} (#{chan_id}) —É–¥–∞–ª—ë–Ω")
    return redirect("admin_panel:channels_page")
destination_types = ["–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞", "–û—Å–Ω–æ–≤–Ω—ã–µ", "–í—Å–µ"]

owners = ["–°–≤–æ–π", "–ß—É–∂–æ–π"]
# admin_panel/views/daily_pinner.py
from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponseRedirect

from api.models import DailyPinningTask, MainEntity
from telegram.models import BotSession


# ============================================================
# üîπ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
# ============================================================
def daily_pinning_tasks_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è."""
    tasks = DailyPinningTask.objects.select_related("channel", "bot").order_by("-created_at")

    context = {
        "tasks": tasks,
        "page_title": "–°–∫—Ä–∏–ø—Ç-–ø—É—Å—Ç—ã—à–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤",
    }
    return render(request, "admin_panel/plugins/daily_pinner/tasks.html", context)


# ============================================================
# üîπ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
# ============================================================
def daily_pinning_task_add(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏."""
    return _daily_pinning_task_edit_common(request, task_id=None)


# ============================================================
# üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================
def daily_pinning_task_edit(request, task_id: int):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏."""
    return _daily_pinning_task_edit_common(request, task_id)


# ============================================================
# üîπ –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è (add/edit)
# ============================================================
def _daily_pinning_task_edit_common(request, task_id=None):
    task = get_object_or_404(DailyPinningTask, id=task_id) if task_id else None
    entities = MainEntity.objects.order_by("name")
    bots = BotSession.objects.filter(is_active=True)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    all_tasks = DailyPinningTask.objects.select_related("channel", "bot").order_by("-created_at")

    if request.method == "POST":
        data = request.POST

        try:
            channel = get_object_or_404(MainEntity, id=data.get("channel_id"))
            bot = get_object_or_404(BotSession, id=data.get("bot_id")) if data.get("bot_id") else bots.last()
        except Exception as e:
            messages.error(request, f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã: {e}")
            return redirect(request.path)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ
        if task is None:
            task = DailyPinningTask.objects.create(
                bot=bot,
                channel=channel,
                post_link=data.get("post_link", ""),
                start_time=data.get("start_time") or "08:00:00",
                end_time=data.get("end_time") or "18:00:00",
                unpin_after_minutes=int(data.get("unpin_after_minutes", 30)),
                delete_notification_after_minutes=int(data.get("delete_notification_after_minutes", 30)),
                is_active=data.get("is_active") == "1",
            )
            messages.success(request, f"–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ #{task.id}")
        else:
            task.bot = bot
            task.channel = channel
            task.post_link = data.get("post_link", "")
            task.start_time = data.get("start_time") or task.start_time
            task.end_time = data.get("end_time") or task.end_time
            task.unpin_after_minutes = int(data.get("unpin_after_minutes", task.unpin_after_minutes))
            task.delete_notification_after_minutes = int(data.get("delete_notification_after_minutes", task.delete_notification_after_minutes))
            task.is_active = data.get("is_active") == "1"
            task.updated_at = timezone.now()
            task.save()
            messages.success(request, f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–µ #{task.id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        return HttpResponseRedirect(reverse("admin_panel:daily_pinning_tasks_view"))

    context = {
        "task": task,
        "entities": entities,
        "bots": bots,
        "all_tasks": all_tasks,
        "page_title": f"–°–∫—Ä–∏–ø—Ç-–ø—É—Å—Ç—ã—à–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤" + ("(–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id})" if task else "(–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)"),
    }
    
    return render(request, "admin_panel/plugins/daily_pinner/task_edit.html", context)


# ============================================================
# üîπ –£–¥–∞–ª–µ–Ω–∏–µ
# ============================================================
def daily_pinning_task_delete(request, task_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏."""
    task = get_object_or_404(DailyPinningTask, id=task_id)
    if request.method == "POST":
        task.delete()
        messages.success(request, f"–ó–∞–¥–∞—á–∞ #{task_id} —É–¥–∞–ª–µ–Ω–∞.")
        return HttpResponseRedirect(reverse("admin_panel:daily_pinning_tasks_view"))

    return render(request, "admin_panel/confirm_delete.html", {
        "object": task,
        "cancel_url": reverse("admin_panel:daily_pinning_tasks_view"),
        "page_title": f"–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id}",
    })from django.contrib.auth.decorators import login_required
from django.shortcuts import render


@login_required
def dashboard(request):
    """
    –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    - advertiser ‚Üí —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å
    - moderator  ‚Üí –º–æ–¥–µ—Ä–∞—Ç–æ—Ä
    """
    user = request.user
    if user.groups.filter(name="Advertiser").exists():
        role = "advertiser"
    else:
        role = "moderator"
    return render(request, "admin_panel/dashboard.html", {"role": role})
from django.http import JsonResponse
from django.contrib.auth.decorators import login_required
from django.views.decorators.csrf import csrf_exempt
from django.shortcuts import render
from admin_panel.models import Country, Category
from api.models import EntityPostTask
import math


# ==================== Pages ====================

@login_required
def directories_page(request):
    """
    –û–±—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏¬ª.
    –°–ª—É–∂–∏—Ç –≤—Ö–æ–¥–Ω–æ–π —Ç–æ—á–∫–æ–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ø–∏—Å–∫–∞–º —Å—Ç—Ä–∞–Ω –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
    """
    return render(request, "admin_panel/directories.html")

@login_required
def countries_page(request):
    countries = Country.objects.all()
    parsed = []
    for c in countries:
        delta = float(c.time_zone_delta or 0)
        sign = "+" if delta >= 0 else "-"
        abs_delta = abs(delta)
        hours = int(abs_delta)
        minutes = int(round((abs_delta - hours) * 60))
        if minutes >= 60:
            minutes = 45
        parsed.append({
            "id": c.id,
            "name": c.name,
            "time_zone_delta": delta,
            "sign": sign,
            "hours": hours,
            "minutes": minutes,
            "delta_str": f"{sign}{hours:02d}:{minutes:02d}"
        })
    return render(request, "admin_panel/countries.html", {"countries": parsed})

@login_required
def categories_page(request):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
    """
    categories = Category.objects.all()
    return render(request, "admin_panel/categories.html", {"categories": categories})


# ==================== Helpers ====================

def _parse_delta_from_request(request):
    """–ë–µ—Ä—ë–º sign, hours, minutes –∏ —Å–æ–±–∏—Ä–∞–µ–º –≤ float."""
    sign = request.POST.get("tz_sign") or "+"
    try:
        hours = int(request.POST.get("tz_hours") or 0)
    except ValueError:
        hours = 0
    try:
        minutes = int(request.POST.get("tz_minutes") or 0)
    except ValueError:
        minutes = 0
    total = hours + minutes / 60
    if sign == "-":
        total = -total
    return total


def _delta_to_str(delta: float) -> str:
    sign = "+" if delta >= 0 else "-"
    abs_delta = abs(delta)

    hours = int(abs_delta)                         # —Ü–µ–ª–∞—è —á–∞—Å—Ç—å
    minutes = int(round((abs_delta - hours) * 60)) # –¥—Ä–æ–±–Ω–∞—è —á–∞—Å—Ç—å –≤ –º–∏–Ω—É—Ç—ã

    # –∑–∞—â–∏—Ç–∞: —á—Ç–æ–±—ã –Ω–µ ¬´–ø—Ä—ã–≥–∞–ª¬ª –≤ 60 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö float
    if minutes >= 60:
        minutes = 45  # —Ç–∞–∫ –∫–∞–∫ —à–∞–≥ –º–∞–∫—Å–∏–º—É–º 45

    return f"{sign}{hours:02d}:{minutes:02d}"




# ==================== AJAX API: Country ====================

@login_required
@csrf_exempt
def country_add_ajax(request):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã.
    –û–∂–∏–¥–∞–µ—Ç POST —Å name, tz_sign, tz_hours, tz_minutes.
    """
    if request.method == "POST":
        name = request.POST.get("name")
        delta = _parse_delta_from_request(request)
        if name:
            country = Country.objects.create(name=name, time_zone_delta=delta)
            return JsonResponse({
                "id": country.id,
                "name": country.name,
                "time_zone_delta": country.time_zone_delta,
                "delta_str": _delta_to_str(country.time_zone_delta)
            })
    return JsonResponse({"error": "bad request"}, status=400)


@login_required
@csrf_exempt
def country_update_ajax(request, pk):
    """
    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã –ø–æ ID.
    –û–∂–∏–¥–∞–µ—Ç POST —Å name, tz_sign, tz_hours, tz_minutes.
    """
    if request.method == "POST":
        try:
            country = Country.objects.get(pk=pk)
        except Country.DoesNotExist:
            return JsonResponse({"error": "not found"}, status=404)

        name = request.POST.get("name")
        if name:
            country.name = name

        delta = _parse_delta_from_request(request)
        country.time_zone_delta = delta
        country.save()

        return JsonResponse({
            "id": country.id,
            "name": country.name,
            "time_zone_delta": country.time_zone_delta,
            "delta_str": _delta_to_str(country.time_zone_delta)
        })

    return JsonResponse({"error": "bad request"}, status=400)


@login_required
@csrf_exempt
def country_delete_ajax(request, pk):
    """
    –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã –ø–æ ID.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"deleted": True} –ø—Ä–∏ —É—Å–ø–µ—Ö–µ.
    """
    if request.method == "POST":
        try:
            Country.objects.get(pk=pk).delete()
            return JsonResponse({"deleted": True})
        except Country.DoesNotExist:
            return JsonResponse({"error": "not found"}, status=404)
    return JsonResponse({"error": "bad request"}, status=400)


# ==================== AJAX API: Category ====================

@login_required
@csrf_exempt
def category_add_ajax(request):
    if request.method == "POST":
        name = request.POST.get("name")
        if name:
            category = Category.objects.create(name=name)
            return JsonResponse({"id": category.id, "name": category.name})
    return JsonResponse({"error": "bad request"}, status=400)


@login_required
@csrf_exempt
def category_update_ajax(request, pk):
    if request.method == "POST":
        try:
            category = Category.objects.get(pk=pk)
        except Category.DoesNotExist:
            return JsonResponse({"error": "not found"}, status=404)

        name = request.POST.get("name")
        if name:
            category.name = name
            category.save()
        return JsonResponse({"id": category.id, "name": category.name})
    return JsonResponse({"error": "bad request"}, status=400)


@login_required
@csrf_exempt
def category_delete_ajax(request, pk):
    if request.method == "POST":
        try:
            Category.objects.get(pk=pk).delete()
            return JsonResponse({"deleted": True})
        except Category.DoesNotExist:
            return JsonResponse({"error": "not found"}, status=404)
    return JsonResponse({"error": "bad request"}, status=400)
import logging
from django.shortcuts import render, redirect, get_object_or_404
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from datetime import timedelta
from django.utils import timezone

from admin_panel.models import Country, Category
from api.models import MainEntity
from .config import destination_types, owners

log = logging.getLogger(__name__)


def _resolve_name(model, val):
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ –ø–æ id –∏–ª–∏ –ø–æ name.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ country/category –∏–∑ —Ñ–æ—Ä–º—ã.
    """
    if not val:
        return None
    s = str(val).strip()
    if s.isdigit():
        try:
            return model.objects.get(id=int(s))
        except model.DoesNotExist:
            return None
    try:
        return model.objects.get(name=s)
    except model.DoesNotExist:
        return None


# ---------- —Å–ø–∏—Å–æ–∫ ----------
@login_required
def entities_page_view(request):
    entities = MainEntity.objects.select_related("country", "category").order_by("-id")

    now = timezone.now()
    for e in entities:
        # –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à, –µ—Å–ª–∏ —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π –∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        if not e.cached_task_updated or (now - e.cached_task_updated).days > 14:
            e.refresh_task_count()

    return render(request, "admin_panel/entities.html", {"entities": entities})



# ---------- –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ----------
@login_required
@require_http_methods(["GET", "POST"])
def entity_add_view(request):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (–∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—ã).
    GET  ‚Üí —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    POST ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ MainEntity
    """
    if request.method == "POST":
        name = (request.POST.get("name") or "").strip()
        link = (request.POST.get("link") or "").strip()
        tags = (request.POST.get("tags") or "").strip()
        tg_id_raw = (request.POST.get("telegram_id") or "").strip()
        country_val = request.POST.get("country") or request.POST.get("country_id")
        category_val = request.POST.get("category") or request.POST.get("category_id")
        owner = (request.POST.get("owner") or "").strip()
        destination_type = (request.POST.get("destination_type") or "").strip()
        entity_type = (request.POST.get("entity_type") or "").strip()
        description = (request.POST.get("description") or "").strip()
        text_suffix = (request.POST.get("text_suffix") or "").strip()

        try:
            # –î–ª—è –≥—Ä—É–ø–ø –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "-" –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            if entity_type == "group" and tg_id_raw and not tg_id_raw.startswith("-"):
                tg_id_raw = f"-{tg_id_raw}"
            telegram_id = int(tg_id_raw)
        except ValueError:
            messages.error(request, "Telegram ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
            return redirect("admin_panel:entities_page")

        country = _resolve_name(Country, country_val)
        category = _resolve_name(Category, category_val)

        obj = MainEntity(
            name=name,
            telegram_id=telegram_id,
            country=country,
            category=category,
            owner=owner,
            entity_type=entity_type,
            destination_type=destination_type,
            link=link,
            tags=tags,
            description=description,
            text_suffix=text_suffix,
            is_add_suffix=False,
        )

        if "photo" in request.FILES:
            obj.photo = request.FILES["photo"]

        obj.save()
        messages.success(request, f"{obj.type_display} {obj.name} —Å–æ–∑–¥–∞–Ω(–∞)")
        return redirect("admin_panel:entities_page")

    return render(request, "admin_panel/entities/add.html", {
        "countries": Country.objects.all(),
        "categories": Category.objects.all(),
        "owners": owners,
        "destination_types": destination_types,
    })


# ---------- —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
@login_required
@require_http_methods(["GET", "POST"])
def entity_edit_view(request, entity_id: int):
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞.
    GET  ‚Üí —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    POST ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ MainEntity
    """
    entity = get_object_or_404(MainEntity, id=entity_id)

    if request.method == "POST":
        entity.name = (request.POST.get("name") or "").strip()
        entity.link = (request.POST.get("link") or "").strip()
        entity.tags = (request.POST.get("tags") or "").strip()
        entity.description = (request.POST.get("description") or "").strip()
        entity.text_suffix = (request.POST.get("text_suffix") or "").strip()
        entity.is_add_suffix = request.POST.get("is_add_suffix") == "1"
        entity.order = request.POST.get("order") or None

        country_val = request.POST.get("country")
        category_val = request.POST.get("category")

        entity.country = _resolve_name(Country, country_val)
        entity.category = _resolve_name(Category, category_val)

        entity.owner = (request.POST.get("owner") or "").strip()
        entity.destination_type = (request.POST.get("destination_type")).strip()

        if "photo" in request.FILES:
            entity.photo = request.FILES["photo"]

        entity.save()
        messages.success(request, f"{entity.type_display} #{entity_id} –æ–±–Ω–æ–≤–ª—ë–Ω(–∞)")
        return redirect("admin_panel:entities_page")

    return render(request, "admin_panel/entities/edit.html", {
        "group_id": entity_id,
        "group": entity,
        "countries": Country.objects.all(),
        "categories": Category.objects.all(),
        "owners": owners,
        "destination_types": destination_types,
    })


# ---------- —É–¥–∞–ª–µ–Ω–∏–µ ----------
@login_required
@require_http_methods(["POST"])
def entity_delete_view(request, entity_id: int):
    """
    –£–¥–∞–ª—è–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–æ.
    """
    entity = get_object_or_404(MainEntity, id=entity_id)
    name = entity.name
    entity.delete()
    messages.success(request, f"{entity.type_display} {name} (#{entity_id}) —É–¥–∞–ª—ë–Ω(–∞)")
    return redirect("admin_panel:entities_page")
import logging
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_http_methods
from django.http import HttpResponseBadRequest
from django.contrib import messages

from api.models import EntityPostTask, ChannelTaskGroup, TaskTime, MainEntity
from telegram.models import BotSession

log = logging.getLogger(__name__)

# ----- –°–ª—É–∂–µ–±–Ω—ã–µ -----
WEEKDAYS = {
    "0": "–ü–Ω", "1": "–í—Ç", "2": "–°—Ä", "3": "–ß—Ç", "4": "–ü—Ç", "5": "–°–±", "6": "–í—Å",
}


def parse_days(days_list):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ int-–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏."""
    if not days_list:
        return []
    if "all" in days_list:
        return list(range(7))
    return [int(d) for d in days_list if d.isdigit()]


# ========================
#   –°–ü–ò–°–û–ö –ì–†–£–ü–ü –ó–ê–î–ê–ß
# ========================
@login_required
def entity_post_tasks_view(request):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –∑–∞–¥–∞—á (ChannelTaskGroup).
    –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ EntityPostTask.
    """
    groups = (
        ChannelTaskGroup.objects
        .prefetch_related("subtasks__bot", "subtasks__source", "subtasks__target", "subtasks__times")
        .all()
    )

    task_groups = []
    for g in groups:
        if not g.subtasks.exists():
            continue

        base = g.subtasks.first()
        targets = [
            {"id": t.target_id, "name": t.target.name if t.target else "‚Äî", "is_active": t.is_active}
            for t in g.subtasks.all() if t.target
        ]

        # –ë–µ—Ä—ë–º –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–π –ø–æ–¥–∑–∞–¥–∞—á–∏ (–ª–æ–∫–∞–ª–∏–∑—É–µ–º –ø–æ –ø–µ—Ä–≤–æ–π –≥—Ä—É–ø–ø–µ)
        time_val = None
        if base.times.exists():
            raw_sec = base.times.first().seconds_from_day_start
            first_target = base.target
            delta = getattr(first_target.country, "time_zone_delta", 0) if (first_target and first_target.country) else 0
            time_val = int((raw_sec + delta * 3600) % 86400)

        task_groups.append({
            "id": g.id,
            "bot": base.bot,
            "source": base.source,
            "is_global_active": all(t.is_global_active for t in g.subtasks.all()),
            "targets_count": len(targets),
            "targets": targets,
            "days": [t.weekday for t in base.times.all()],
            "time": time_val,
            "choice_mode": base.choice_mode,
            "after_publish": base.after_publish,
        })

    return render(request, "admin_panel/plugins/entity_post/tasks.html", {
        "task_groups": task_groups,
        "weekdays": WEEKDAYS,
    })


# ========================
#   –°–û–ó–î–ê–ù–ò–ï
# ========================
@login_required
@require_http_methods(["GET", "POST"])
def entity_post_task_create(request):
    if request.method == "POST":
        try:
            bot = BotSession.objects.last()
            if not bot:
                return HttpResponseBadRequest("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–æ—Ç–æ–≤")

            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–æ—Ä–º—ã
            source_id = request.POST.get("source_id")
            choice_mode = request.POST.get("choice_mode", "random")
            after_publish = request.POST.get("after_publish", "cycle")
            days = parse_days(request.POST.getlist("days"))
            hours = int(request.POST.get("hours", 12))
            minutes = int(request.POST.get("minutes", 0))
            sec_local = hours * 3600 + minutes * 60
            target_ids = request.POST.getlist("target_ids")
            is_global_active = request.POST.get("is_global_active") == "1"

            log.info(f"{target_ids} Test")

            if not source_id or not target_ids:
                return HttpResponseBadRequest("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π")

            # –°–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—É
            group = ChannelTaskGroup.objects.create()

            # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–∑–∞–¥–∞—á–∏
            for idx, tid in enumerate(target_ids):
                is_active = request.POST.get(f"is_active_{idx}") == "1"
                target_entity = MainEntity.objects.filter(pk=tid).select_related("country").first()
                if not target_entity:
                    continue

                delta = getattr(target_entity.country, "time_zone_delta", 0) if target_entity.country else 0
                sec = int((sec_local - delta * 3600) % 86400)

                task = EntityPostTask.objects.create(
                    bot=bot,
                    group=group,
                    choice_mode=choice_mode,
                    after_publish=after_publish,
                    source=MainEntity.objects.filter(pk=source_id).first(),
                    target=target_entity,
                    is_active=is_active,
                    is_global_active=is_global_active,
                )


                for d in days:
                    TaskTime.objects.create(task=task, weekday=d, seconds_from_day_start=sec)

            messages.success(request, f"–°–æ–∑–¥–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ #{group.id}")
            return redirect("admin_panel:entity_post_tasks_view")

        except Exception as e:
            log.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á")
            return HttpResponseBadRequest(f"–û—à–∏–±–∫–∞: {e}")

    entities = MainEntity.objects.all().order_by("order", "name")

    return render(request, "admin_panel/plugins/entity_post/task_create.html", {
        "weekdays": WEEKDAYS,
        "entities": entities
    })


# ========================
#   –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
# ========================
@login_required
@require_http_methods(["GET", "POST"])
def entity_post_task_edit(request, group_id: int):
    group = get_object_or_404(ChannelTaskGroup, pk=group_id)
    tasks = list(group.subtasks.select_related("target", "source"))

    if not tasks:
        return HttpResponseBadRequest("–£ –≥—Ä—É–ø–ø—ã –Ω–µ—Ç –ø–æ–¥–∑–∞–¥–∞—á")

    base = tasks[0]

    if request.method == "POST":
        try:
            bot = BotSession.objects.last()
            if not bot:
                return HttpResponseBadRequest("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–æ—Ç–æ–≤")

            source_id = request.POST.get("source_id")
            choice_mode = request.POST.get("choice_mode", "random")
            after_publish = request.POST.get("after_publish", "cycle")
            is_global_active = request.POST.get("is_global_active") == "1"

            EntityPostTask.objects.filter(group=group).update(is_global_active=is_global_active)
            days = parse_days(request.POST.getlist("days"))

            def _as_int(val, default):
                try:
                    return int(val)
                except (TypeError, ValueError):
                    return default

            hours = _as_int(request.POST.get("hours"), 12)
            minutes = _as_int(request.POST.get("minutes"), 0)
            sec_local = hours * 3600 + minutes * 60

            deleted_raw = request.POST.get("deleted_targets", "")
            ids_to_delete = [int(i) for i in deleted_raw.split(",") if i.strip().isdigit()]
            if ids_to_delete:
                EntityPostTask.objects.filter(group=group, id__in=ids_to_delete).delete()

            # --- —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã ---
            target_ids_raw = request.POST.getlist("target_ids")
            task_ids_raw = request.POST.getlist("task_ids")
            is_active_vals = [request.POST.get(f"is_active_{i}") for i in range(len(target_ids_raw))]

            if not source_id or not target_ids_raw:
                return HttpResponseBadRequest("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π")

            # —Å–ª–æ–≤–∞—Ä—å: task_id ‚Üí (target_id, is_active)
            submitted = {}
            for idx, tid in enumerate(target_ids_raw):
                tid = int(tid)
                task_id = task_ids_raw[idx] if idx < len(task_ids_raw) else None
                is_active_local = (is_active_vals[idx] == "1")
                submitted[task_id or f"new-{idx}"] = (tid, is_active_local)

            # --- –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ ---
            for t in EntityPostTask.objects.filter(group=group).order_by("id"):
                if str(t.id) not in submitted:
                    continue

                tid, is_active_local = submitted[str(t.id)]
                target_entity = MainEntity.objects.filter(pk=tid).select_related("country").first()
                delta = getattr(target_entity.country, "time_zone_delta", 0) if (target_entity and target_entity.country) else 0
                sec_stored = int((sec_local - delta * 3600) % 86400)

                t.bot = bot
                t.choice_mode = choice_mode
                t.after_publish = after_publish
                t.source = MainEntity.objects.filter(pk=source_id).first()
                t.target = target_entity
                t.is_active = is_active_local
                t.is_global_active = is_global_active
                t.save()

                TaskTime.objects.filter(task=t).delete()
                for d in days:
                    TaskTime.objects.create(task=t, weekday=d, seconds_from_day_start=sec_stored)

            # --- –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ ---
            for key, (tid, is_active_local) in submitted.items():
                if not key.startswith("new-"):
                    continue

                target_entity = MainEntity.objects.filter(pk=tid).select_related("country").first()
                delta = getattr(target_entity.country, "time_zone_delta", 0) if (target_entity and target_entity.country) else 0
                sec_stored = int((sec_local - delta * 3600) % 86400)

                new_task = EntityPostTask.objects.create(
                    group=group,
                    bot=bot,
                    choice_mode=choice_mode,
                    after_publish=after_publish,
                    source=MainEntity.objects.filter(pk=source_id).first(),
                    target=target_entity,
                    is_active=is_active_local,
                    is_global_active=is_global_active,
                )

                for d in days:
                    TaskTime.objects.create(task=new_task, weekday=d, seconds_from_day_start=sec_stored)

            messages.success(request, f"–ì—Ä—É–ø–ø–∞ #{group.id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
            return redirect("admin_panel:entity_post_tasks_view")

        except Exception as e:
            log.exception("–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á")
            return HttpResponseBadRequest(f"–û—à–∏–±–∫–∞: {e}")

    # --- GET ---
    times = TaskTime.objects.filter(task=base).order_by("weekday", "seconds_from_day_start")
    days = [str(t.weekday) for t in times]

    time_hours, time_minutes = 12, 0
    if times.exists():
        raw_sec = times.first().seconds_from_day_start
        g = base.target
        delta = getattr(g.country, "time_zone_delta", 0) if (g and g.country) else 0
        local_sec = int((raw_sec + delta * 3600) % 86400)
        time_hours, time_minutes = local_sec // 3600, (local_sec % 3600) // 60

    entities = MainEntity.objects.all().order_by("order", "name")

    return render(request, "admin_panel/plugins/entity_post/task_edit.html", {
        "tasks": tasks,
        "weekdays": WEEKDAYS,
        "entities": entities,
        "days": days,
        "time_hours": time_hours,
        "time_minutes": time_minutes,
    })


# ========================
#   –£–î–ê–õ–ï–ù–ò–ï
# ========================
@login_required
@require_http_methods(["POST"])
def entity_post_task_delete(request, group_id: int):
    try:
        group = get_object_or_404(ChannelTaskGroup, pk=group_id)
        count = group.subtasks.count()
        group.delete()
        messages.success(request, f"–£–¥–∞–ª–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ #{group_id} ({count} –ø–æ–¥–∑–∞–¥–∞—á)")
        return redirect("admin_panel:entity_post_tasks_view")
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á")
        return HttpResponseBadRequest(f"–û—à–∏–±–∫–∞: {e}")
from .dashboard import dashboard
from .directories import (
    countries_page,
    categories_page,
    country_add_ajax,
    category_add_ajax,
    country_update_ajax,
    category_update_ajax,
    country_delete_ajax,
    category_delete_ajax,
    directories_page

)
from .entities import entities_page_view, entity_add_view, entity_edit_view, entity_delete_view
from .bots import *
from .plugins import (
	plugins_page,
	plugin_action,
	plugin_logs
)

from .entity_post import (
	entity_post_task_create,
	entity_post_task_delete,
	entity_post_task_edit,
	entity_post_tasks_view,

)


from .ads_post import (
	ads_tasks_view,
	ads_task_add,
	ads_task_edit,
	ads_task_delete,
)

from .daily_pinning import (
	daily_pinning_tasks_view,
	daily_pinning_task_add,
	daily_pinning_task_edit,
	daily_pinning_task_delete
)

from .booster_settings import (
	booster_settings_view,
	booster_check_ajax
)

from .view_boost import (
	view_boost_tasks_view,
	view_boost_task_add,
	view_boost_task_edit,
	view_boost_task_delete,
)

from .old_views_boost import (
	old_views_tasks_view,
	old_views_task_add,
	old_views_task_edit,
	old_views_task_delete
)

from .subscribers_booster import (
	subscribers_tasks_view,
	subscribers_task_add,
	subscribers_task_edit,
	subscribers_task_delete
)# admin_panel/views/old_views_booster.py

from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponseRedirect
from django.db.models import Sum
from datetime import timedelta

from api.models import OldViewsTask, OldViewsExpense, MainEntity
from telegram.models import BotSession


# ============================================================
# üîπ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
# ============================================================
def old_views_tasks_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤."""
    tasks = OldViewsTask.objects.select_related("target").order_by("-created_at")

    # –ü–æ–¥—Å—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü
    for task in tasks:
        start_date = timezone.now() - timedelta(days=30)
        period_expense = OldViewsExpense.objects.filter(
            task=task,
            created_at__gte=start_date
        ).aggregate(total=Sum('price'))['total'] or 0
        task.monthly_expense_value = period_expense

    context = {
        "tasks": tasks,
        "page_title": "–°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ—Å—Ç–æ–≤",
    }
    return render(request, "admin_panel/plugins/old_views_booster/tasks.html", context)


# ============================================================
# üîπ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
# ============================================================
def old_views_task_add(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏."""
    return _old_views_task_edit_common(request, task_id=None)


# ============================================================
# üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================
def old_views_task_edit(request, task_id: int):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏."""
    return _old_views_task_edit_common(request, task_id)


# ============================================================
# üîπ –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è (add/edit)
# ============================================================
def _old_views_task_edit_common(request, task_id=None):
    task = get_object_or_404(OldViewsTask, id=task_id) if task_id else None
    entities = MainEntity.objects.order_by("name")
    last_bot = BotSession.objects.filter(is_active=True).last()

    # –í—Å–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    all_tasks = OldViewsTask.objects.select_related("target").order_by("-created_at")
    all_tasks_data = []
    for t in all_tasks:
        start_date = timezone.now() - timedelta(days=30)
        period_expense = OldViewsExpense.objects.filter(
            task=t,
            created_at__gte=start_date
        ).aggregate(total=Sum('price'))['total'] or 0
        all_tasks_data.append({
            'id': t.id,
            'is_active': t.is_active,
            'target': t.target,
            'normalization_mode': t.normalization_mode,
            'posts_normalization': t.posts_normalization,
            'subscribers_count': t.subscribers_count,
            'view_coefficient': t.view_coefficient,
            'views_multiplier': t.views_multiplier,
            'monthly_expense_value': period_expense,
        })

    if request.method == "POST":
        data = request.POST
        target = get_object_or_404(MainEntity, id=data.get("target_id"))

        if task is None:
            task = OldViewsTask.objects.create(
                target=target,
                bot=last_bot,
                normalization_mode=data.get("normalization_mode", "monthly"),
                posts_normalization=data.get("posts_normalization", "last_100"),
                view_coefficient=int(data.get("view_coefficient", 50)),
                views_multiplier=int(data.get("views_multiplier", 1)),
                is_active=data.get("is_active") == "1",
            )
            messages.success(request, f"–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ #{task.id}")
        else:
            task.target = target
            task.normalization_mode = data.get("normalization_mode", task.normalization_mode)
            task.posts_normalization = data.get("posts_normalization", task.posts_normalization)
            task.view_coefficient = int(data.get("view_coefficient", task.view_coefficient))
            task.views_multiplier = int(data.get("views_multiplier", task.views_multiplier))
            task.is_active = data.get("is_active") == "1"
            task.updated_at = timezone.now()
            task.save()
            messages.success(request, f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–µ #{task.id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        return HttpResponseRedirect(reverse("admin_panel:old_views_tasks_view"))

    context = {
        "task": task,
        "entities": entities,
        "all_tasks": all_tasks_data,
        "page_title": f"–°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ—Å—Ç–æ–≤" + (f" (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id})" if task else " (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)"),
    }
    return render(request, "admin_panel/plugins/old_views_booster/task_edit.html", context)


# ============================================================
# üîπ –£–¥–∞–ª–µ–Ω–∏–µ
# ============================================================
def old_views_task_delete(request, task_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏."""
    task = get_object_or_404(OldViewsTask, id=task_id)
    if request.method == "POST":
        task.delete()
        messages.success(request, f"–ó–∞–¥–∞—á–∞ #{task_id} —É–¥–∞–ª–µ–Ω–∞.")
        return HttpResponseRedirect(reverse("admin_panel:old_views_tasks_view"))

    return render(request, "admin_panel/confirm_delete.html", {
        "object": task,
        "cancel_url": reverse("admin_panel:old_views_tasks_view"),
        "page_title": f"–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id}",
    })

# admin_panel/views/plugins.py
import logging
import docker
from typing import Dict, Any

from django.shortcuts import render, get_object_or_404, redirect
from django.http import HttpResponseBadRequest
from django.contrib.auth.decorators import login_required

from admin_panel.models import Plugin

log = logging.getLogger(__name__)

REQ_TIMEOUT = 5  # seconds


# ==================== Docker helpers ====================

def _docker():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç Docker SDK."""
    return docker.from_env()

def _container_status(name: str | None) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
    - not_configured: –µ—Å–ª–∏ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ
    - not_found: –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
    - –∏–Ω–∞—á–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å ("running", "exited" –∏ —Ç.–¥.)
    """
    if not name:
        return "not_configured"
    try:
        c = _docker().containers.get(name)
        return c.status or "unknown"
    except Exception as e:
        log.debug("docker get(%s) failed: %s", name, e)
        return "not_found"

def _serialize(p: Plugin) -> Dict[str, Any]:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ–±—ä–µ–∫—Ç Plugin –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —à–∞–±–ª–æ–Ω–∞."""
    container = getattr(p, "container_name", None)
    return {
        "id": p.id,
        "name": p.name,
        "description": p.description or "",
        "is_active": bool(p.is_active),
        "category": getattr(p, "category", "system") or "system",
        "container_name": container or "",
        "docker_status": _container_status(container),
        "slug": p.slug,
    }


# ==================== Views ====================

@login_required
def plugins_page(request):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–ª–∞–≥–∏–Ω–æ–≤.
    –ü–ª–∞–≥–∏–Ω—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: working, system, theme.
    """
    plugins = Plugin.objects.all()
    categorized = {"working": [], "system": [], "theme": []}
    for p in plugins:
        d = _serialize(p)
        cat = d["category"] if d["category"] in categorized else "working"
        categorized[cat].append(d)

    return render(request, "admin_panel/plugins/plugins.html", {
        "working_plugins": categorized["working"],
        "system_plugins": categorized["system"],
        "theme_plugins": categorized["theme"],
    })


@login_required
def plugin_action(request, plugin_id: int, action: str):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –ø–ª–∞–≥–∏–Ω–∞:
    - start
    - stop
    - restart
    """
    p = get_object_or_404(Plugin, pk=plugin_id)
    container = getattr(p, "container_name", None)
    if not container:
        return HttpResponseBadRequest("Container is not configured for this plugin")

    client = _docker()
    try:
        c = client.containers.get(container)
    except Exception:
        c = None

    if action == "start":
        if not c:
            return HttpResponseBadRequest("Container not found")
        c.start()
        p.is_active = True
    elif action == "stop":
        if not c:
            return HttpResponseBadRequest("Container not found")
        c.stop()
        p.is_active = False
    elif action == "restart":
        if not c:
            return HttpResponseBadRequest("Container not found")
        c.restart()
        p.is_active = True
    else:
        return HttpResponseBadRequest("Unknown action")

    p.save()
    return redirect("admin_panel:plugins_page")


@login_required
def plugin_logs(request, plugin_id: int):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    GET-–ø–∞—Ä–∞–º–µ—Ç—Ä tail –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 500).
    """
    from django.conf import settings
    p = get_object_or_404(Plugin, pk=plugin_id)
    container = getattr(p, "container_name", None)
    if not container:
        return HttpResponseBadRequest("Container is not configured for this plugin")

    tail = int(request.GET.get("tail", getattr(settings, "PLUGINS_DEFAULT_LOG_TAIL", 500)))
    try:
        c = _docker().containers.get(container)
        logs = c.logs(tail=tail).decode("utf-8", errors="replace")
    except Exception as e:
        logs = f"Failed to read logs: {e}"

    d = _serialize(p)
    return render(request, "admin_panel/plugins/plugin_logs.html", {
        "plugin": d,
        "tail": tail,
        "logs": logs,
    })
# admin_panel/views/subscribers_booster.py

from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponseRedirect
from django.db.models import Sum
from datetime import timedelta

from api.models import (
    SubscribersBoostTask,
    SubscribersBoostExpense,
    SubscribersCheck,
    MainEntity,
)
from telegram.models import BotSession


# ============================================================
# üîπ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
# ============================================================
def subscribers_tasks_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤."""
    tasks = SubscribersBoostTask.objects.select_related("target").order_by("-created_at")

    now = timezone.now()
    week_ago = now - timedelta(days=7)
    month_ago = now - timedelta(days=30)
    two_days_ago = now - timedelta(days=2)
    yesterday = now - timedelta(days=1)
    today = now

    for task in tasks:
        # –†–∞—Å—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü
        monthly_expense = SubscribersBoostExpense.objects.filter(
            task=task, created_at__gte=month_ago
        ).aggregate(total=Sum("price"))["total"] or 0
        task.monthly_expense_value = monthly_expense

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –æ—Ç–ø–∏—Å–æ–∫
        weekly_checks = SubscribersCheck.objects.filter(task=task, created_at__gte=week_ago)
        monthly_checks = SubscribersCheck.objects.filter(task=task, created_at__gte=month_ago)

        weekly_subs = weekly_checks.aggregate(s=Sum("new_subscriptions"))["s"] or 0
        weekly_unsubs = weekly_checks.aggregate(s=Sum("new_unsubscriptions"))["s"] or 0
        monthly_subs = monthly_checks.aggregate(s=Sum("new_subscriptions"))["s"] or 0
        monthly_unsubs = monthly_checks.aggregate(s=Sum("new_unsubscriptions"))["s"] or 0

        task.weekly_unsubs = weekly_unsubs
        task.monthly_unsubs = monthly_unsubs
        task.weekly_total = weekly_subs - weekly_unsubs
        task.monthly_total = monthly_subs - monthly_unsubs

        # –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –ø–æ –¥–∞—Ç–∞–º
        checks = SubscribersCheck.objects.filter(task=task).order_by("-created_at")[:3]
        by_date = {}
        for ch in checks:
            d = ch.created_at.date()
            by_date[d] = ch.total_subscribers
        task.day_before_yesterday_value = by_date.get(two_days_ago.date(), 0)
        task.yesterday_value = by_date.get(yesterday.date(), 0)
        task.today_value = by_date.get(today.date(), 0)

    context = {
        "tasks": tasks,
        "page_title": "–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤",
    }
    return render(request, "admin_panel/plugins/subscribers_booster/tasks.html", context)


# ============================================================
# üîπ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
# ============================================================
def subscribers_task_add(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤."""
    return _subscribers_task_edit_common(request, task_id=None)


# ============================================================
# üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================
def subscribers_task_edit(request, task_id: int):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤."""
    return _subscribers_task_edit_common(request, task_id)


# ============================================================
# üîπ –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è (add/edit)
# ============================================================
def _subscribers_task_edit_common(request, task_id=None):
    task = get_object_or_404(SubscribersBoostTask, id=task_id) if task_id else None
    entities = MainEntity.objects.order_by("name")
    last_bot = BotSession.objects.filter(is_active=True).last()

    # –í—Å–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    all_tasks = SubscribersBoostTask.objects.select_related("target").order_by("-created_at")
    all_tasks_data = []
    now = timezone.now()
    week_ago = now - timedelta(days=7)
    month_ago = now - timedelta(days=30)

    for t in all_tasks:
        monthly_expense = SubscribersBoostExpense.objects.filter(
            task=t, created_at__gte=month_ago
        ).aggregate(total=Sum("price"))["total"] or 0
        weekly_checks = SubscribersCheck.objects.filter(task=t, created_at__gte=week_ago)
        monthly_checks = SubscribersCheck.objects.filter(task=t, created_at__gte=month_ago)

        weekly_unsubs = weekly_checks.aggregate(s=Sum("new_unsubscriptions"))["s"] or 0
        monthly_unsubs = monthly_checks.aggregate(s=Sum("new_unsubscriptions"))["s"] or 0

        all_tasks_data.append({
            'id': t.id,
            'is_active': t.is_active,
            'target': t.target,
            'check_interval': t.check_interval,
            'tracking_mode': t.tracking_mode,
            'weekly_unsubs': weekly_unsubs,
            'monthly_unsubs': monthly_unsubs,
            'monthly_expense_value': monthly_expense,
        })

    if request.method == "POST":
        data = request.POST
        target = get_object_or_404(MainEntity, id=data.get("target_id"))

        check_interval = int(data.get("check_interval", 60))
        tracking_mode = data.get("tracking_mode", "unsubs")
        is_active = data.get("is_active") == "1"
        max_subscribers = int(data.get("max_subscribers", 0))
        notify_on_exceed = data.get("notify_on_exceed") == "1"


        if task is None:
            task = SubscribersBoostTask.objects.create(
                target=target,
                bot=last_bot,
                check_interval=check_interval,
                tracking_mode=tracking_mode,
                is_active=is_active,
            )
            messages.success(request, f"–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ #{task.id}")
        else:
            task.target = target
            task.check_interval = check_interval
            task.tracking_mode = tracking_mode
            task.is_active = is_active
            task.updated_at = timezone.now()
            task.save()
            messages.success(request, f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–µ #{task.id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        return HttpResponseRedirect(reverse("admin_panel:subscribers_tasks_view"))

    context = {
        "task": task,
        "entities": entities,
        "all_tasks": all_tasks_data,
        "page_title": "–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤" + (f" (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id})" if task else " (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)"),
    }
    return render(request, "admin_panel/plugins/subscribers_booster/task_edit.html", context)


# ============================================================
# üîπ –£–¥–∞–ª–µ–Ω–∏–µ
# ============================================================
def subscribers_task_delete(request, task_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤."""
    task = get_object_or_404(SubscribersBoostTask, id=task_id)
    if request.method == "POST":
        task.delete()
        messages.success(request, f"–ó–∞–¥–∞—á–∞ #{task_id} —É–¥–∞–ª–µ–Ω–∞.")
        return HttpResponseRedirect(reverse("admin_panel:subscribers_tasks_view"))

    return render(request, "admin_panel/confirm_delete.html", {
        "object": task,
        "cancel_url": reverse("admin_panel:subscribers_tasks_view"),
        "page_title": f"–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id}",
    })
# admin_panel/views/view_boost.py

from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponseRedirect
from django.db.models import Sum
from datetime import datetime, timedelta

from api.models import ViewBoostTask, ViewBoostExpense, MainEntity
from telegram.models import BotSession


# ============================================================
# üîπ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
# ============================================================
def view_boost_tasks_view(request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á —É–º–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞."""
    tasks = ViewBoostTask.objects.select_related("target").order_by("-created_at")
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü/–Ω–µ–¥–µ–ª—é –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
    for task in tasks:
        if task.show_expenses_for == "week":
            start_date = timezone.now() - timedelta(days=7)
            period_label = "–Ω–µ–¥."
        else:  # month
            start_date = timezone.now() - timedelta(days=30)
            period_label = "–º–µ—Å."
            
        period_expense = ViewBoostExpense.objects.filter(
            task=task,
            created_at__gte=start_date
        ).aggregate(total=Sum('price'))['total'] or 0
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è –≤ –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏
        task.expenses_period_value = period_expense
        task.expenses_period_label = period_label

    context = {
        "tasks": tasks,
        "page_title": "–£–º–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤",
    }
    return render(request, "admin_panel/plugins/view_boost/tasks.html", context)


# ============================================================
# üîπ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
# ============================================================
def view_boost_task_add(request):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏."""
    return _view_boost_task_edit_common(request, task_id=None)


# ============================================================
# üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================================
def view_boost_task_edit(request, task_id: int):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏."""
    return _view_boost_task_edit_common(request, task_id)


# ============================================================
# üîπ –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è (add/edit)
# ============================================================
def _view_boost_task_edit_common(request, task_id=None):
    task = get_object_or_404(ViewBoostTask, id=task_id) if task_id else None
    entities = MainEntity.objects.order_by("name")
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞
    last_bot = BotSession.objects.filter(is_active=True).last()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏
    all_tasks_data = []
    all_tasks = ViewBoostTask.objects.select_related("target").order_by("-created_at")
    
    for t in all_tasks:
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
        if t.show_expenses_for == "week":
            start_date = timezone.now() - timedelta(days=7)
            period_label = "–Ω–µ–¥."
        else:  # month
            start_date = timezone.now() - timedelta(days=30)
            period_label = "–º–µ—Å."
            
        period_expense = ViewBoostExpense.objects.filter(
            task=t,
            created_at__gte=start_date
        ).aggregate(total=Sum('price'))['total'] or 0
        
        all_tasks_data.append({
            'id': t.id,
            'is_active': t.is_active,
            'target': t.target,
            'subscribers_count': t.subscribers_count,
            'view_coefficient': t.view_coefficient,
            'day_before_yesterday_percent': t.day_before_yesterday_percent,
            'yesterday_percent': t.yesterday_percent,
            'today_percent': t.today_percent,
            'show_expenses_for': t.show_expenses_for,
            'period_expense': period_expense,
            'period_label': period_label,
        })

    if request.method == "POST":
        data = request.POST

        try:
            target = get_object_or_404(MainEntity, id=data.get("target_id"))
        except Exception as e:
            messages.error(request, f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª: {e}")
            return redirect(request.path)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ
        if task is None:
            task = ViewBoostTask.objects.create(
                target=target,
                bot=last_bot,
                view_coefficient=int(data.get("view_coefficient", 50)),
                normalization_mode=data.get("normalization_mode", "daily"),
                show_expenses_for=data.get("show_expenses_for", "month"),
                is_active=data.get("is_active") == "1",
            )
            messages.success(request, f"–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ #{task.id}")
        else:
            task.target = target
            task.view_coefficient = int(data.get("view_coefficient", task.view_coefficient))
            task.normalization_mode = data.get("normalization_mode", task.normalization_mode)
            task.show_expenses_for = data.get("show_expenses_for", task.show_expenses_for)
            task.is_active = data.get("is_active") == "1"
            task.updated_at = timezone.now()
            task.save()
            messages.success(request, f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–µ #{task.id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

        return HttpResponseRedirect(reverse("admin_panel:view_boost_tasks_view"))

    context = {
        "task": task,
        "entities": entities,
        "all_tasks": all_tasks_data,
        "page_title": f"–£–º–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤" + (f" (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id})" if task else " (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)"),
    }
    
    return render(request, "admin_panel/plugins/view_boost/task_edit.html", context)


# ============================================================
# üîπ –£–¥–∞–ª–µ–Ω–∏–µ
# ============================================================
def view_boost_task_delete(request, task_id: int):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏."""
    task = get_object_or_404(ViewBoostTask, id=task_id)
    if request.method == "POST":
        task.delete()
        messages.success(request, f"–ó–∞–¥–∞—á–∞ #{task_id} —É–¥–∞–ª–µ–Ω–∞.")
        return HttpResponseRedirect(reverse("admin_panel:view_boost_tasks_view"))

    return render(request, "admin_panel/confirm_delete.html", {
        "object": task,
        "cancel_url": reverse("admin_panel:view_boost_tasks_view"),
        "page_title": f"–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{task.id}",
    })